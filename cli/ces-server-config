#!/usr/bin/env bash

cd $SICES_PATH

if [ -z ${1+x} ] || [ $1 == '--development' ]; then

  cp cli/ces-pre-push .git/hooks/pre-push

  echo 'Creating database... enter your mysql password:'
  mysql -u root -p -e 'CREATE DATABASE sices_solar;'
  ces-database-mirror

  echo 'Creating params file...'
  sed 's/BASH_REPLACES_THIS_PASSWORD/XYZ/g' <app/config/parameters_development.yml >app/config/parameters.yml

elif [ $1 == '--homolog' ]; then

  FLAG=homolog

elif [ $1 == '--production' ]; then

  FLAG=production

fi

if [ $FLAG == 'homolog' ] || [ $FLAG == 'production' ]; then

  echo "Importing Sices $FLAG variables..."
  source ces-variables-ci --$FLAG

  # Remote automatic start Bundle App and Server
  echo "Sices starting Bundle App on: $CES_BUNDLE_HOST:$CES_BUNDLE_PORT"
  cd bundle/app
  npm install
  node_modules/.bin/pm2 start index.js --node-args="--harmony" -n "bundle"
  cd $SICES_PATH

  mkdir .temp
  mkdir .mirror
  mkdir .backup

  echo 'Creating params file...'
  cp app/config/parameters_$FLAG.yml app/config/parameters.yml

fi

echo 'Creating config file...'
cp app/config/config_sample.yml app/config/config.yml

touch web/deploy/deploy.log

echo 'Sices updating schema...'
php app/console doctrine:schema:update --force

echo 'Done.'
