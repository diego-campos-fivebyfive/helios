{% extends view('layout') %}

{% block body %}

    <link href="{{ asset('assets/iCheck/custom.css') }}" rel="stylesheet">
    <link href="{{ asset('assets/iCheck/skins/all.css') }}" rel="stylesheet">
    <style>
        .col-md-12 {
            margin-top: 10px;
        }

        .check-persistent {
            margin-top: 15px;
        }
        .box-check-persistent {
            height: 25px;
        }
        .clear-date-input {
            width: 80%;
            float: left;
        }
        .clear-date-btn {
            width: 20%;
        }
        .clear-date-group {
            width: 100%;
        }
    </style>

    <div class="wrapper wrapper-content animated fadeInRight">
        {% if account.id is null %}
            <div class="btn-group" style="margin-bottom: 5px">
                <a class="btn btn-default"
                   href="{{ path('account_index') }}">
                    <i class="fa fa-arrow-left"></i> Voltar
                </a>
            </div>
        {% else %}
        <div class="btn-group" style="margin-bottom: 5px">
            <a class="btn btn-default"
               href="{{ path('account_show',{'id':account.id}) }}">
                <i class="fa fa-arrow-left"></i> Voltar
            </a>
        </div>
        {% endif %}

        {% if account.id is not null %}
        {% include view('admin/accounts/info_status.html.twig') %}
        {% endif %}

        <div class="panel panel-success">
            <div class="panel-heading">
                Conta <label> {{ account.firstname }} </label>
            </div>
            <div class="panel-body">
                <div class="row">
                    {{ form_start(form,{attr:{id:'form-pre-register'}}) }}

                    <div class="col-md-12">
                        <div class="col-md-4">
                            {{ form_label(form.document, 'CNPJ *',{label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.document,{attr:{class:'form-control', 'data-mask':'00.000.000/0000-00', 'placeholder':'CNPJ'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.extraDocument, 'Inscrição Estadual', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.extraDocument,{attr:{class:'form-control', 'placeholder':'Inscrição Estadual'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.lastname, 'Razão Social *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.lastname,{attr:{class:'form-control', 'placeholder':'Razão Social'}}) }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="col-md-4">
                            {{ form_label(form.firstname, 'Nome Fantasia *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.firstname,{attr:{class:'form-control', 'placeholder':'Nome Fantasia'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.email, 'E-mail *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.email,{attr:{class:'form-control', 'placeholder':'E-mail'}}) }}
                        </div>

                        {% if account.id is null %}
                            {# new account #}
                            {% set form_owner = attribute(form.members, 0) %}
                        {% else %}
                            {# update account #}
                            {% set form_owner = form.owner %}
                        {% endif %}

                        <div class="col-md-4">
                            {{ form_label(form_owner.firstname, 'Pessoa para Contato *') }}
                            {{ form_widget(form_owner.firstname,{attr:{class:'form-control', 'placeholder':'Pessoa para Contato'}}) }}
                        </div>

                    </div>
                    <div class="col-md-12">
                        <div class="col-md-4">
                            {{ form_label(form.phone, 'Telefone *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.phone,{attr:{class:'form-control', 'placeholder':'Telefone'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.postcode, 'CEP *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.postcode,{attr:{class:'form-control', 'data-mask':'00000-000', 'placeholder':'CEP'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.state, 'Estado *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.state,{attr:{class:'form-control', 'placeholder':'Estado'}}) }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="col-md-4">
                            {{ form_label(form.city, 'Cidade *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.city,{attr:{class:'form-control', 'placeholder':'Cidade'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.district, 'Bairro *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.district,{attr:{class:'form-control', 'placeholder':'Bairro'}}) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.street, 'Logradouro *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.street,{attr:{class:'form-control', 'placeholder':'Logradouro'}}) }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="col-md-4">
                            {{ form_label(form.number, 'Número *', {label_attr:{class:'pull-left'}}) }}
                            {{ form_widget(form.number,{attr:{class:'form-control', 'placeholder':'Número'}}) }}
                        </div>

                        {% set isPlatform = app.user.isPlatformAdmin or app.user.isPlatformMaster or app.user.isPlatformExpanse %}
                        {% if isPlatform %}
                        <div class="col-md-4">
                            {{ form_label(form.level, 'Nivel de Conta *') }}
                            {{ form_widget(form.level,{attr:{class:'form-control', 'placeholder':'Status'}}) }}
                        </div>
                        {% endif %}

                        {% if form.agent is defined %}
                            <div class="col-md-4">
                                {{ form_label(form.agent, 'Agente Comercial *') }}
                                {{ form_widget(form.agent,{attr:{class:'form-control', 'placeholder':'Status'}}) }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        {% if form.parentAccount is defined %}
                            <div class="col-md-4">
                                {{ form_label(form.parentAccount, 'Conta Mãe') }}
                                {{ form_widget(form.parentAccount,{attr:{class:'form-control', 'placeholder':'Conta Mãe'}}) }}
                            </div>
                        {% endif %}

                        {% if app.user.isPlatformAdmin or app.user.isPlatformMaster or app.user.isPlatformExpanse %}
                            <div class="col-md-4">
                                <div class="btn-group clear-date-group">
                                    {{ form_label(form.persistentAt, 'Data de persistência:') }}
                                    {{ form_widget(form.persistentAt, {attr:{class:'form-control clear-date-input'}}) }}
                                    <button type="button" id="clear_date" class="btn btn-primary clear-date-btn">
                                        <i class="fa fa-eraser"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        <div class="form-group col-md-2 pull-right" style="margin-top: 24px;">
                            <button class="btn btn-md btn-primary ladda-button btn-block" data-style="zoom-in"
                                    id="btn-pre-submit">
                                <i class="fa fa-save"></i> Salvar
                            </button>
                        </div>
                    </div>

                </div>
                <div class="form-group hide">{{ form_rest(form) }}</div>
                {{ form_end(form) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}

    <script>

        var persistentAt = $('#account_persistentAt');

        function display_error(message){
            toastr.error(message, '', {
                positionClass: 'toast-top-center',
                progressBar: true,
                preventDuplicates: true
            });
        }

        $('#account_phone').mask(function (val) {
            return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
        });
    </script>

    {% if errors|length %}
        <script>
            {% for key, error in errors if 0 == key %}
            display_error('{{ error.message|trans([],'messages') }}');
            {% endfor %}
        </script>
    {% endif %}


    <script>
        function resolveParent(selected) {
            if(selected) {
                $('#account_level').attr('disabled', 'disabled');
                $('#account_agent').attr('disabled', 'disabled');
            } else {
                $('#account_level').removeAttr('disabled');
                $('#account_agent').removeAttr('disabled');
            }
        }

        resolveParent($('#account_parentAccount').val());

        $('#account_parentAccount').on('change', function () {
            resolveParent($(this).val());
        });

        $('#account_email').change(function () {
            $('#account_member_email').val($(this).val());
            $('#account_member_users_email').val($(this).val());
            $('#account_member_users_username').val($(this).val());
        });

        $('#account_phone').change(function () {
            $('#account_member_phone').val($(this).val());
        });

        $(function () {
            $('.middle-box').removeClass('middle-box');
        });
        $('#account_postcode').change(function () {
            $.ajax({
                url: '{{ path('utils_postcode') }}',
                method: 'post',
                data: {postcode: $('#account_postcode').val()},
                complete: function (xhr) {
                    if (xhr.status == 200 && xhr.responseJSON.status == 200) {
                        $('#account_state').val(xhr.responseJSON.state);
                        $('#account_city').val(xhr.responseJSON.city);
                        $('#account_district').val(xhr.responseJSON.neighborhood);
                        $('#account_street').val(xhr.responseJSON.street);
                    }
                }
            });
        });

        $('#pre_register_phone').mask(function (val) {
            return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
        });

        $('#form-pre-register').on('submit', function(event){
            $('#btn-pre-submit').ladda();
            $('#btn-pre-submit').ladda('start');
        });

        $('#account_parentAccount option[value=""]').html('Sem vínculo');

        $('#account_parentAccount').chosen();

        persistentAt.daterangepicker({
            startDate: '{{ account.persistentAt ? account.persistentAt|date('d/m/Y') : 'now'|date('d/m/Y') }}',
            singleDatePicker: true,

            locale: {
                format: 'DD/MM/YYYY',
                daysOfWeek: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
                monthNames: [
                    "Janeiro",
                    "Fevereiro",
                    "Março",
                    "Abril",
                    "Maio",
                    "Junho",
                    "Julho",
                    "Agosto",
                    "Setembro",
                    "Outubro",
                    "Novembro",
                    "Dezembro"
                ]
            }
        })

        {% if not account.persistentAt %}
            persistentAt.val('');
        {% endif %}

        $('#clear_date').on('click', function () {
            persistentAt.val('');
        });
    </script>

{% endblock %}
