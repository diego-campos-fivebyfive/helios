{% set showActions = not app.user.isPlatformFinancial and not app.user.isPlatformAfterSales %}
<table class="table table-striped table-hover">
    <thead>
    <tr>
        <th class="col-md-4">Nome</th>
        <th class="col-md-5">E-mail</th>
        <th class="col-md-3">Nivel de Usuário</th>
    </tr>
    </thead>
    <tbody>
    {% for member in members %}
        {% set is_user = member.user and member.user.same(app.user) %}
        {% set is_owner = member.isOwner or member.getAttribute('is_owner', false) %}
        {% set is_master = member.masterOwner %}

        <tr>
            <td> {{ member.firstname }} </td>
            <td>
                {% if showActions %}
                    <a class="label label-primary" data-user-email="{{ path('email_user_update', { 'id': member.id }) }}">
                        <i class="fa fa-pencil"></i></a>
                {% endif %}
                <span id="{{ member.id }}">{{ member.email }}</span>
            </td>
            <td data-value="{{ member.isOwner ? 'a' : 'z' }}">
                {% if is_owner %}
                    <a class="label label-{{ is_master ? 'info' : 'default' }}"
                            {% if not is_master %}
                                data-admin="{{ member.id }}"
                                data-name="{{ member.firstname }}"
                            {% endif %}
                    >
                        {{ is_master ? 'Account Owner'|trans : 'Administrator'|trans }}
                        {% if not is_master %}
                            <i class='fa fa-arrow-circle-up'></i>
                        {% endif %}
                    </a>
                {% else %}
                    <div class="label label-{{ is_user ? 'info' : 'default' }}" style="width: 100%;">
                        {{ is_user ? 'Account User'|trans : 'Usuário Comum'|trans }}
                    </div>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<script>
    $("[data-admin]").on('click', function () {

        var url = "{{ path('switch_account_owner_api', {id: account.id}) }}";
        var target = $(this).data('admin');
        var name = $(this).data('name');

        swal({
            title: "Deseja tornar " + name + " dono da conta?",
            text: "O usuário " + "{{ account.owner.firstname }}" + " será convertido em Administrador.",
            type: "info",
            showCancelButton: true,
            cancelButtonText: "{{ 'Cancel'|trans }}",
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "{{ 'Confirm'|trans }}",
            closeOnConfirm: false
        }, function () {
            $.ajax({
                url: url,
                method: 'post',
                data: {target:target},
                complete: function (xhr) {
                    if (200 == xhr.status) {
                        swal("{{ 'Success'|trans }}", "Atualização executada com sucesso!", "success");

                        window.setTimeout(function(){
                            listMembers();
                            swal.close();
                        }, 1000);
                    } else {
                        swal("{{ 'Error'|trans }}!", 'Falha no processo de atualização', "error");
                    }
                },
                beforeSend: function () {
                    swal({
                        title: "Atualizando...",
                        text: "Aguarde",
                        type: "info",
                        showConfirmButton: false
                    });
                }
            });
        });
    });

    var dataEmail = $('[data-user-email]');
    if(dataEmail.length){
        dataEmail.on('click', function () {
            var url = $(this).data('user-email');

            $.ajax({
                url: url,
                method: 'post',
                data: {_method:'post'},
                complete: function (xhr) {
                    if (200 == xhr.status) {
                        $('#email_form').html(xhr.responseJSON['form_email']);
                    } else {
                        swal("{{ 'Error'|trans }}!", 'Falha ao editar', "error");
                    }
                }
            });

        });
    }
</script>