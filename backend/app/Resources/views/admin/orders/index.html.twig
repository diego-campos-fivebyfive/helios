{% extends view('layout') %}

{% block styles %}

    <style>
        table tbody tr {
            display: table-row !important;
        }

        .label.label-status {
            background-color: #f2f2f2;
            border: 1px solid #b2b2b2;
            color: #555;
        }

        .label.status-building i {
            color: #898989;
        }

        .label.status-pending i {
            color: #ff7701;
        }

        .label.status-validated i {
            color: #0a6aa1;
        }

        .label.status-approved i {
            color: #00a157;
        }

        .label.status-rejected i {
            color: #ffcd70;
        }

        .label.status-done i {
            color: #777;
        }

        .label.status-inserted i {
            color: #1aa10f;
        }

        .label.status-available i {
            color: #faa;
        }

        .label.status-collected i {
            color: #43ecec;
        }

        .label.status-delivering i {
            color: #95ec41;
        }

        .validated {
            color: #0a6aa1;
        }

        .group-input select {
            float: left;
            width: 30%;
        }

        .group-input input {
            float: left;
            width: 55%;
        }

        .group-input button {
            width: 15%;
            border-radius: 0  2px 2px 0;
        }
        .chosen-choices {
            border-radius: 1px;
            padding: 2px !important;
        }
        #filter_optionsVal {
            width: 40%;
        }
        #filter_valueMin , #filter_valueMax {
            width: 30%;
        }
        .open>.dropdown-toggle.btn-success[aria-expanded='true'] {
            background-color: #0a6aa1;
            border-color: #0a6aa1;
        }
    </style>

{% endblock %}

{% block body %}

    {% set displayProforma = member.isPlatformFinancial or member.isPlatformAfterSales %}
    {% set displayFilePayment = member.isPlatformFinancial %}
    {% set allowAdd = not displayProforma and not member.isPlatformExpanse and not member.isPlatformFinancing %} {# TODO: Regra temporária #}

    <div class="modal inmodal" id="e_modal_accounts" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <h2><i class="fa fa-bookmark"></i> {{ 'Accounts'|trans }}</h2>
                </div>
                <div class="modal-body" id="content_accounts">
                    {% include view('Helper.spinner') %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="modal_files" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <h4 class="modal-title">
                        <i class="fa fa-file-text"></i> Comprovantes de Pagamento
                    </h4>
                </div>
                <div class="modal-body">
                    {% include view('helper.spinner') %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        <i class="fa fa-close"></i> {{ 'Close'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="tags_modal" class="modal fade" tabindex="-1" role="dialog">
    </div>

    <div class="wrapper wrapper-content animated fadeInRight">

        <div class="row">
            <div class="col-md-12">
                <div class="ibox-title flow-lg">
                    <span class="pull-left">
                        <a data-toggle="collapse" href="#filtros">
                            <h4>
                                <i class="fa fa-archive"> </i> Filtros
                            </h4>
                        </a>
                    </span>
                </div>

                <div id="filtros" class="collapse {{ hasFilter == true ? "in" }}" style="padding-top: 10px; background-color: white; border: 10px; border-style: solid; border-color: white">
                    {{ form_start(form, {attr:{id:'form-filter'}}) }}

                    {% set hasAgent = attribute(form, 'agent') is defined %}
                    <div class="row">
                        <div class="form-group col-md-3">
                            {{ form_widget(form.like,{attr:{class:'form-control', placeholder: 'nome, razão social, etc...'}}) }}
                        </div>

                        <div class="col-md-2">
                            {% include view('admin/helper/status_filter.html.twig') %}
                        </div>

                        <div class="group-input col-md-5">
                            {{ form_widget(form.optionsAt,{attr:{class:'form-control'}}) }}
                            {{ form_widget(form.dateAt,{attr:{class:'form-control', placeholder:'Filtrar p/ data' }}) }}
                            <button type="button" id="clear-dateAt" class="btn btn-primary ">
                                <i class="fa fa-eraser"></i>
                            </button>
                        </div>

                        {% if hasAgent %}
                            <div class="col-md-2">
                                {{ form_widget(form.agent,{attr:{class:'form-control'}}) }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="row form-group">

                        <div class="col-md-2">
                            {% include view('admin/helper/states_filter.html.twig') %}
                        </div>

                        <div class="col-md-3">
                            {% include view('admin/helper/components_filter.html.twig') %}
                        </div>

                        <div class="group-input col-md-4">
                            {{ form_widget(form.optionsVal,{attr:{class:'form-control'}}) }}
                            {{ form_widget(form.valueMin,{attr:{class:'form-control', placeholder:'Mínimo' }}) }}
                            {{ form_widget(form.valueMax,{attr:{class:'form-control', placeholder:'Máximo' }}) }}
                        </div>

                        <div class="col-lg-3">
                            <div class="form-group col-md-12">
                                {{ form_widget(form.antecipatedBilling) }}
                                {{ form_label(form.antecipatedBilling, 'Faturamento antecipado') }}
                            </div>
                        </div>

                        <div class="col-md-2 pull-right">
                            <button type="submit" class="btn btn-primary btn-md btn-block">
                                <i class="fa fa-search"></i> Pesquisar
                            </button>
                        </div>

                        <div class="hide">
                            {{ form_rest(form) }}
                        </div>
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        <div class="row" id="real-content">
            <div class="col-md-12">
                <div class="ibox-title flow-lg">
                    <span class="pull-left">
                        <h4>
                        <i class="fa fa-files-o"> </i> Solicitações
                        </h4>
                    </span>

                    {% if allowAdd %}
                        <span class="pull-right small text-muted">
                            <a data-url="{{ path('accounts_list') }}"
                               data-toggle="modal"
                               data-target="#modal_accounts"
                               class="btn btn-success btn-xs col-md-12">
                                <i class="fa fa-plus"></i> <small>Orçamento</small>
                            </a>
                        </span>
                    {% endif %}

                    <span class="pull-right small text-muted">
                        <div class="dropdown col-md-12">
                            <button class="btn btn-success btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
                                <i class="fa fa-table"> </i> <small>Exportar</small>
                                <span class="caret"></span></button>
                            <ul class="dropdown-menu" style="left: -50px">
                                <li><a href="{{ path('export_list',{mode:1}|merge(app.request.query.all) ) }}">Orçamentos</a></li>
                                <li><a href="{{ path('export_list',{mode:2}|merge(app.request.query.all) ) }}">Sistemas</a></li>
                                <li><a href="{{ path('export_list',{mode:3}|merge(app.request.query.all) ) }}">Aguardando Material</a></li>
                            </ul>
                        </div>
                    </span>

                    <span class="pull-right small text-muted">
                        {% set count = orders.totalItemCount %}
                        <h4 class="col-md-12">
                            {% if count == 0 %} Nenhuma {% else %} {{ count }} {% endif %}
                            {% if count <= 1 %} Solicitação encontrada {% else %} Solicitações encontradas {% endif %}
                        </h4>
                    </span>

                    <span class="pull-right small text-muted">
                        <h4 class="col-md-12">
                            Valor dos orçamentos: {{ totals.total|currency }}
                        </h4>
                    </span>

                    <span class="pull-right small text-muted">
                        <h4 class="col-md-12">
                            Potência total: {{ totals.power|number_format(2,',','.') }} kWp
                        </h4>
                    </span>
                </div>
                <div class="ibox flow-h">
                    <div class="ibox-content flow-lg">

                        <table class="table table-stripped">
                            <thead>
                                <tr>
                                    <th class="text-center col-md-1"> Número</th>
                                    <th class="text-center col-md-2"> Integrador</th>
                                    <th class="text-center col-md-1"> Atendente</th>
                                    <th class="text-center col-md-2"> Sistemas</th>
                                    <th class="text-center col-md-1"> Status</th>
                                    <th class="text-center col-md-4"> Arquivos</th>
                                    <th class="text-center col-md-1"> Tags</th>
                                </tr>
                            </thead>
                            <tbody>

                            {% for order in orders %}
                                <tr>
                                    <td class="text-center">
                                        {% if order.reference %}
                                            <a href="{{ path('order_show', {id: order.id}) }}"><h4> {{ order.reference }} </h4></a>
                                        {% else %}
                                            <a href="{{ path('order_show', {id: order.id}) }}"><h4> Visualizar </h4></a>
                                        {% endif %}

                                        {% if order.createdAt %}
                                            <small>
                                                {{ order.createdAt|date('d/m/Y') }}
                                            </small>
                                        {% endif %}
                                    </td>

                                    <td class="text-center">
                                        <h4>{{ order.account ? order.account.firstname : 'Não definido' }}</h4>
                                        <small>
                                            {{ order.cnpj }}
                                        </small>
                                    </td>

                                    <td class="text-center">
                                        {% set notLevel = 'Sem Nivel' %}
                                        <h4>
                                            <div class="label label-level label-size level-{{ order.account ? order.account.level : notLevel }}">
                                            </div>
                                        </h4>
                                        <small style="margin-top: 4px;">{{ order.agent }}</small>

                                    </td>

                                    <td class="text-center">
                                        <h4>
                                            {% if order.childrens.count %}
                                                {% for children in order.childrens %}
                                                    {{ children.power }} kWp,
                                                {% endfor %}
                                            {% else %}
                                                Sem sistemas
                                            {% endif %}
                                        </h4>
                                        <small> {{ order.total|currency }} </small>
                                    </td>

                                    <td class="text-center">
                                        <h5>
                                            <span class="label label-status status-{{ order.statusName }}">
                                                <i class="fa fa-circle"></i> {{ order.statusName|capitalize|trans }}:
                                                {% if order.statusAt %}
                                                    {{ order.statusAt|date('d/m/Y') }}
                                                {% endif %}
                                            </span>
                                        </h5>
                                        {% if order.deliveryAt %}
                                            <small>
                                                Disponível: {{ order.deliveryAt|date('d/m/Y') }}
                                            </small>
                                        {% endif %}
                                    </td>

                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm col-md-12 btn-group-justified">
                                            {% if order.hasProforma %}
                                                <a class="btn btn-default {{ order.proforma ? 'validated' }}"
                                                   href="{{ path('order_file',{id:order.id, type:'proforma'}) }}"
                                                   target="_blank"> <i class="fa fa-file-pdf-o"></i>
                                                    <br>
                                                    <small>Prof.</small>
                                                </a>
                                            {% else %}
                                                <i class="btn btn-default fa fa-file-pdf-o">
                                                    <br>
                                                    <small>Prof.</small>
                                                </i>
                                            {% endif %}

                                            {% set shippingRules = order.shippingRules %}

                                            {% include view('admin/orders/shipping_info.html.twig') %}

                                            {% if order.hasFile('payment') %}
                                                <a data-toggle="modal"
                                                   data-target="#modal_files"
                                                   data-url="{{ path('order_files',{id:order.id, type: 'payment'}) }}"
                                                   class="btn btn-default {{ order.hasFile('payment') ? 'validated' }}">
                                                    <i class="fa fa-file-text"></i>
                                                    <br>
                                                    <small>Comprov. </small>
                                                </a>
                                            {% else %}
                                                <i class="btn btn-default fa fa-file-text">
                                                    <br>
                                                    <small>Comprov.</small>
                                                </i>
                                            {% endif %}

                                        </div>
                                    </td>

                                    <td class="text-center">
                                        {% set role = user.role %}

                                        {% if order.tags(role) %}
                                            <a data-toggle="modal"
                                               data-target="#tags_modal"
                                               data-url="{{ path('modal_tags', {id: order.id}) }}"
                                                class="btn modal_tags">
                                            {% set count = 0 %}
                                            {% for orderTag in order.tags(role) %}
                                                {% if count == 3  %}
                                                    <br>
                                                    {% set count = 0 %}
                                                {% endif %}
                                                <span class="label label-default" title="{{ orderTag.name }}" style="background-color: {{ orderTag.tag_color }}; margin-right: 1px; padding-top: 1px">
                                                    <font color="{{ orderTag.text_color }}">
                                                        {{ orderTag.initials }}
                                                    </font>
                                                </span>
                                                {% set count = count + 1 %}
                                            {% endfor %}
                                            </a>
                                        {% else %}
                                            <a data-toggle="modal"
                                               data-target="#tags_modal"
                                               data-url="{{ path('modal_tags', {id: order.id}) }}"
                                               class="btn btn-default btn-xs modal_tags">
                                                <i class="fa fa-plus-square"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>

                            {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row text-center">
        <div class="btn-group bt-xs">
            {{ knp_pagination_render(orders) }}
        </div>
    </div>

{% endblock %}

{% block scripts %}

    {% include view('helper.request') %}
    {% include view('helper.plugins_js') %}

    <script>

        var content_accounts = $('#content_accounts');
        $('[data-target="#modal_accounts"]').on('click', function () {
            var url = $(this).data('url');

            $('#e_modal_accounts').modal('show');
            if (url) {
                $.ajax({
                    url: url,
                    method: 'get',
                    complete: function (xhr) {
                        content_accounts.html(xhr.responseText);
                    }
                });
            } else {
                content_accounts.html('<h2> Erro ao selecionar Integrador</h2>');
            }
        });

        var dateAt = $('#filter_dateAt');

        dateAt.daterangepicker({
            locale: {
                format: 'DD/MM/YYYY',
                daysOfWeek: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
                monthNames: [
                    "Janeiro",
                    "Fevereiro",
                    "Março",
                    "Abril",
                    "Maio",
                    "Junho",
                    "Julho",
                    "Agosto",
                    "Setembro",
                    "Outubro",
                    "Novembro",
                    "Dezembro"
                ]
            }
        });

        dateAt.val('');

        $('#clear-dateAt').on('click', function () {
            dateAt.val('');
        });

        var ModalTags = $('#tags_modal');

        $('.modal_tags').on('click', function () {
            var url = $(this).data('url');
            $.ajax({
                url: url,
                success: function (response) {
                    ModalTags.html(response);
                }
            });
        });

        var doReload = false;
        ModalTags.on('hidden.bs.modal', function () {
            if (doReload) {
                location.reload();
            }
        });

        var modalFiles = $('#modal_files');

        modalFiles.on('show.bs.modal', function(event){
            var target = $(event.relatedTarget);
            var url = target.data('url');
            modalFiles.find('.modal-body').load(url);
        });

        var form_filtration = $("#form-filter");

        if(form_filtration.length){
            StateFilter(form_filtration);
            StatusFilter(form_filtration);
            ComponentFilter(form_filtration);
        }

        $('#filter_valueMin').on('change', function () {
            if ($('#filter_valueMax').val()) {
                var thisValue = Number($(this).val().replace(',','.'));
                var value = Number($('#filter_valueMax').val().replace(',','.'));

                if (thisValue > value) {
                    $(this).val((value.toString()).replace('.',','));
                    $('#filter_valueMax').val((thisValue.toString()).replace('.',','));
                }
            }
        });

        $('#filter_valueMax').on('change', function () {
            if ($('#filter_valueMin').val()) {
                var thisValue = Number($(this).val().replace(',','.'));
                var value = Number($('#filter_valueMin').val().replace(',','.'));

                if (thisValue < value) {
                    $(this).val((value.toString()).replace('.',','));
                    $('#filter_valueMin').val((thisValue.toString()).replace('.',','));
                }
            }
        });

        var sanitize = function(element){
            function clear(v){ return v.replace(/\D+/g,''); }
            var value = element.val();
            var backup = value.replace(/\./g,',');
            value = clear(value);
            if(backup.indexOf(',') > 0){
                var commas = backup.split(',');
                value = clear(commas[0])+',';
                if(commas[1].length){
                    value += clear(commas[1]);
                }
            }
            if(0 == backup.indexOf('-')){
                if(2 == backup.split('-').length){
                    value = '-' + value;
                }
            }
            element.val(value);
        };

        var custom_mask = function(element){
            element.on('keyup', function(){
                sanitize(element);
            });
        };

        var common_mask = {pattern: '##,##', reverse: true};
        var targets = {
            'filter_valueMin': common_mask,
            'filter_valueMax': common_mask
        };

        $.each(targets, function (id, options) {
            custom_mask($('#'+id));
        });
    </script>

{% endblock %}
