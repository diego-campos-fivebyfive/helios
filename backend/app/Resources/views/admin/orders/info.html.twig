<style>
    #form_order_info textarea {
        resize: none;
        height: 125px;
    }
</style>

<script type="text/javascript" src="{{ asset('assets/fullcalendar/lib/moment.min.js') }}"></script>
<script type="text/javascript" src="{{ asset('assets/daterangepicker/daterangepicker.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{ asset('assets/daterangepicker/daterangepicker.css') }}" />

<div class="modal inmodal" id="e_modal_accounts" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInRight">
            <div class="modal-header">
                <h2><i class="fa fa-bookmark"></i> {{ 'Accounts'|trans }}</h2>
            </div>
            <div class="modal-body" id="content_accounts">
                {% include view('Helper.spinner') %}
            </div>
        </div>
    </div>
</div>

<div class="row" id="block_form_info">

    {{ form_start(form,{attr:{action: app.request.uri, id:'form_order_info'}}) }}

    <div class="form-group col-md-12">
        <div class="col-md-6">
            {{ form_label(form.paymentMethod, 'Condição de Pagamento') }}
            {{ form_widget(form.paymentMethod, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-6" id="block_account_selector">
            {% if attribute(form, 'account') is defined %}
                {{ form_label(form.account, 'Integrador') }}
                <br>
                <a data-url="{{ path('accounts_list') }}"
                   data-toggle="modal"
                   data-target="#modal_accounts"
                   class="btn btn-success">
                    <i class="fa fa-user"></i> Selecionar Integrador
                </a>
                {{ form_widget(form.account, {attr:{class:'hidden'}}) }}
            {% endif %}
        </div>
    </div>

    <div class="hr-line-dashed col-md-12"></div>

    <div class="form-group col-md-12">
        <div class="col-md-4">
            {{ form_label(form.firstname, 'Cliente') }}
            {{ form_widget(form.firstname, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-4">
            {{ form_label(form.lastname, 'Nome') }}
            {{ form_widget(form.lastname, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-4">
            {{ form_label(form.cnpj) }}
            {{ form_widget(form.cnpj, {attr:{class:'form-control'}}) }}
        </div>
    </div>

    <div class="form-group col-md-12">
        <div class="col-md-4">
            {{ form_label(form.ie, 'Inscrição Estadual') }}
            {{ form_widget(form.ie, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-4">
            {{ form_label(form.contact) }}
            {{ form_widget(form.contact, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-4">
            {{ form_label(form.email) }}
            {{ form_widget(form.email, {attr:{class:'form-control'}}) }}
        </div>
    </div>

    <div class="form-group col-md-12">
        <div class="col-md-3">
            {{ form_label(form.phone) }}
            {{ form_widget(form.phone, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-2">
            {{ form_label(form.postcode) }}
            {{ form_widget(form.postcode, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-1">
            {{ form_label(form.state) }}
            {{ form_widget(form.state, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.city) }}
            {{ form_widget(form.city, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.address) }}
            {{ form_widget(form.address, {attr:{class:'form-control'}}) }}
        </div>
    </div>

    <div class="hr-line-dashed col-md-12"></div>

    <div class="form-group col-md-12">

        <div class="col-md-9">
            {{ form_label(form.note, 'Observações') }}
            {{ form_widget(form.note, {attr:{class:'form-control'}}) }}
        </div>

        <div class="col-md-3">
            <div class="row">
                <div class="col-md-12">
                    {#{{ form_label(form.deliveryAt, 'Disponibilidade de Entrega (data)') }}
                    {{ form_widget(form.deliveryAt, {attr:{class:'form-control', 'data-mask':'00/00/0000', placeholder: '__/__/____'}}) }}#}

                    <label for="delivery_at">Disponibilidade de Entrega</label>
                    <input class="form-control" id="delivery_at" type="text">
                </div>
                <div class="col-md-12" id="order_deadline_block" style="margin-top: 30px;">
                    {{ form_label(form.deadline, 'Prazo de Entrega (dias)') }}
                    {{ form_widget(form.deadline, {attr:{class:'form-control'}}) }}
                </div>
            </div>
        </div>

    </div>

    <div class="form-group col-md-12">
        <div class="col-md-9">&nbsp;</div>
        <div class="col-md-3">
            <button id="button_account" type="submit" data-style="zoom-in"
                    class="btn btn-success btn-block ladda-button">
                <i class="fa fa-save"></i> Salvar
            </button>
        </div>
    </div>

    <div class="form-group hide">
        {{ form_rest(form) }}
    </div>

</div>

{{ form_end(form) }}

<script>

    var buttonAccount = $('#button_account');

    var InfoManager = {
        accountSelector: $('#order_account'),
        shippingSelector: null,
        deadlineBlock: $('#order_deadline_block'),
        deliveryAt: $('#order_deliveryAt'),
        date_delivery: $('#date_range'),
        getAccount: function () {
            return this.accountSelector.val();
        },
        getShippingType: function(){
            return this.shippingSelector.val();
        },
        fillAccount: function (data) {
            $.each(data, function (i, value) {
                $('#order_' + i).val(value);
            });
        },
        checkShippingOption: function(){
            if('self' != this.getShippingType()){
                this.deadlineBlock.show();
            }else{
                this.deadlineBlock.hide();
            }
        },
        init: function(){

            var checkShippingTypePresence = window.setInterval(function(){
                InfoManager.shippingSelector = $('#shipping_type');
                if(InfoManager.shippingSelector.length){
                    clearInterval(checkShippingTypePresence);
                    InfoManager.shippingSelector.on('change', function(){
                        InfoManager.checkShippingOption();
                    });
                    InfoManager.checkShippingOption();
                }
            }, 500);
        }
    };

    InfoManager.init();

    $('#form_order_info').on('submit', function (event) {
        event.preventDefault();

        buttonAccount.ladda();
        buttonAccount.ladda('start');

        var form = $(this);
        $.ajax({
            url: form.attr('action'),
            method: form.attr('method'),
            data: form.serialize(),
            complete: function (xhr) {
                if (200 == xhr.status) {

                    if (InfoManager.getAccount()) {
                        $('#block_account_selector').remove();
                    }

                } else {
                    swal('Ooops', 'Falha ao executar a operação.', 'error');
                }

                buttonAccount.ladda('stop');
            }
        });
    });

    $('#order_postcode').on('change', function () {
        var postcode = $(this).val();
        $.ajax({
            url: '{{ path('utils_postcode') }}',
            method: 'post',
            data: {postcode: postcode},
            complete: function (xhr) {
                if (200 == xhr.status) {
                    var response = xhr.responseJSON;
                    $('#order_state').val(response.uf);
                    $('#order_city').val(response.cidade);
                    $('#order_district').val(response.bairro);
                    $('#order_address').val(response.tipo_logradouro + ' ' + response.logradouro);
                }
            }
        });
    });

    var content_accounts = $('#content_accounts');
    $('[data-target="#modal_accounts"]').on('click', function () {
        var url = $(this).data('url');

        $('#e_modal_accounts').modal('show');
        if (url) {
            $.ajax({
                url: url,
                method: 'get',
                complete: function (xhr) {
                    content_accounts.html(xhr.responseText);
                }
            });
        } else {
            content_accounts.html('<h2> Erro ao selecionar Integrador</h2>');
        }
    });

    var customized = false;
    $('#delivery_at').daterangepicker({
        startDate: '{{ order.deliveryAt|date('d/m/Y') }}',
        singleDatePicker: true,
        minDate: moment(),
        locale: {
            format: 'DD/MM/YYYY',
            daysOfWeek: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
            monthNames: [
                "Janeiro",
                "Fevereiro",
                "Março",
                "Abril",
                "Maio",
                "Junho",
                "Julho",
                "Agosto",
                "Setembro",
                "Outubro",
                "Novembro",
                "Dezembro"
            ]
        }
    }).on('apply.daterangepicker', function(event, picker){
        $('input[name="order[deliveryAt]"]').val(picker.startDate.format('DD/MM/YYYY'));
    }).on('show.daterangepicker', function(){
        if (!customized) {
            $('.calendar').prepend();
            customized = true;
        }
    });
</script>
