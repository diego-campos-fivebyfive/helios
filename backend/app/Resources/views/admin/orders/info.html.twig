<style>
    #form_order_info textarea {
        resize: none;
        height: 125px;
    }
    .client.input-label, .client.input-label:focus {
        border-color: transparent;
        width: 100%;
    }
    .clear-date-input {
        width: 80%;
        float: left;
    }
    .clear-date-btn {
        width: 20%;
    }
    .clear-date-group {
        width: 100%;
    }
</style>

<script type="text/javascript" src="{{ asset('assets/fullcalendar/lib/moment.min.js') }}"></script>
<script type="text/javascript" src="{{ asset('assets/daterangepicker/daterangepicker.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{ asset('assets/daterangepicker/daterangepicker.css') }}" />

<div class="row" id="block_form_info">

    {{ form_start(form,{attr:{action: app.request.uri, id:'form_order_info'}}) }}

    <div class="col-md-12">
        {{ form_widget(form.billingDirect) }}
        {{ form_label(form.billingDirect, 'Dados de faturamento') }}
    </div>

    <div id="billing_direct_inputs" class="form-group col-md-12 hide">
        <div class="col-md-3">
            {{ form_label(form.billingFirstname, 'Cliente') }}
            {{ form_widget(form.billingFirstname, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingLastname, 'Razão social') }}
            {{ form_widget(form.billingLastname, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingContact, 'Contato') }}
            {{ form_widget(form.billingContact, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingCnpj, 'CNPJ') }}
            {{ form_widget(form.billingCnpj, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingIe, 'IE') }}
            {{ form_widget(form.billingIe, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingPhone, 'Telefone') }}
            {{ form_widget(form.billingPhone, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingEmail, 'Email') }}
            {{ form_widget(form.billingEmail, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingPostcode, 'CEP') }}
            {{ form_widget(form.billingPostcode, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingCity, 'Cidade') }}
            {{ form_widget(form.billingCity, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingState, 'Estado') }}
            {{ form_widget(form.billingState, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingDistrict, 'Bairro') }}
            {{ form_widget(form.billingDistrict, {attr:{class:'form-control billing'}}) }}
        </div>
        <div class="col-md-3">
            {{ form_label(form.billingStreet, 'Rua') }}
            {{ form_widget(form.billingStreet, {attr:{class:'form-control billing'}}) }}
        </div>
    </div>

    <div class="hr-line-dashed col-md-12"></div>

    <div class="form-group col-md-6">
        <div class="col-md-3">
            {{ form_label(form.firstname, 'Cliente') }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.firstname, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.cnpj) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.cnpj, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.phone) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.phone, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.email) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.email, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.postcode) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.postcode, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.address) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.address, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-4">
            <strong>Nível de desconto</strong>:
        </div>
        <div class="col-md-8">
            {{ order.account.level|trans }}
        </div>
    </div>
    <div class="col-md-6">
        <div class="col-md-3">
            {{ form_label(form.lastname, 'Nome') }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.lastname, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.ie, 'IE') }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.ie, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.contact) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.contact, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.state) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.state, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-3">
            {{ form_label(form.city) }}:
        </div>
        <div class="col-md-9">
            {{ form_widget(form.city, {attr:{class:'client input-label'}}) }}
        </div>

        <div class="col-md-5">
            <strong>Usuário Sices vinculado</strong>:
        </div>
        <div class="col-md-7">
            {{ order.agent }}
        </div>
    </div>

    <div class="hr-line-dashed col-md-12"></div>

    <div class="form-group col-md-12">
        <div class="col-md-6">
            {{ form_label(form.paymentMethod, 'Condição de Pagamento') }}
            {{ form_widget(form.paymentMethod, {attr:{class:'form-control', readonly: 'readonly'}}) }}
        </div>
    </div>

    <div class="hr-line-dashed col-md-12"></div>

    <div class="form-group col-md-12">

        <div class="col-md-12">
            <div class="row">
                <div class="col-md-3">
                    <label for="delivery_at">Disp. para Coleta (data)</label>
                </div>
                <div class="col-md-3">
                    {{ form_label(form.deliveryDelay, 'Disp. para Coleta (dias após pagamento)') }}
                </div>
                <div class="col-md-3 order_deadline_block">
                    {{ form_label(form.deadline, 'Prazo de Entrega (dias)') }}
                </div>
                <div class="col-md-3">
                    {{ form_label(form.expireDays, 'Validade da proposta (dias)') }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-3" style="margin-top: 5px;">
                    <div class="btn-group clear-date-group">
                        <input class="form-control clear-date-input" id="delivery_at" type="text" readonly="readonly">
                        <button type="button" id="clear_date" class="btn btn-primary clear-date-btn">
                            <i class="fa fa-eraser"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3" style="margin-top: 5px;">
                    {{ form_widget(form.deliveryDelay, {attr:{class:'form-control', readonly: 'readonly'}}) }}
                </div>
                <div class="col-md-3 order_deadline_block" style="margin-top: 5px;">
                    {{ form_widget(form.deadline, {attr:{class:'form-control', readonly: 'readonly'}}) }}
                </div>
                <div class="col-md-3" style="margin-top: 5px;">
                    {{ form_widget(form.expireDays, {attr:{class:'form-control', readonly: 'readonly'}}) }}
                </div>
            </div>
        </div>

        <div class="col-md-12" style="margin-top: 5px;">
            {{ form_label(form.note, 'Observações a serem inseridas na pró-forma') }}
            {{ form_widget(form.note, {attr:{class:'form-control', readonly: 'readonly'}}) }}
        </div>
    </div>

    <div class="form-group col-md-12">
        <div class="col-md-9">&nbsp;</div>
        <div class="col-md-3">
            <a id="button_edit" class="btn btn-success btn-block">
                <i class="fa fa-edit"></i> Editar
            </a>
            <button id="button_account" type="submit" data-style="zoom-in"
                    class="btn btn-success btn-block ladda-button hide">
                <i class="fa fa-save"></i> Salvar
            </button>
        </div>
    </div>

    <div class="form-group hide">
        {{ form_rest(form) }}
    </div>

</div>

{{ form_end(form) }}
<script>

    var buttonAccount = $('#button_account');
    var buttonEdit = $('#button_edit');

    $(buttonEdit).on('click', function () {
        InfoManager.clickByPayment = true;
        InfoManager.editable = true;
        InfoManager.changeEditable(true);
    });

    var InfoManager = {
        editable: false,
        billingDirect: $('#order_billingDirect'),
        billing_direct_inputs: $('#billing_direct_inputs'),
        clickByPayment: false,
        accountSelector: $('#order_account'),
        shippingSelector: null,
        deadlineBlock: $('.order_deadline_block'),
        deliveryAt: $('#order_deliveryAt'),
        date_delivery: $('#date_range'),
        getAccount: function () {
            return this.accountSelector.val();
        },
        getShippingType: function(){
            return this.shippingSelector.val();
        },
        setDeliveryAt: function(deliveryAt){
            this.deliveryAt.val(deliveryAt);
        },
        fillAccount: function (data) {
            $.each(data, function (i, value) {
                $('#order_' + i).val(value);
            });
        },
        checkShippingOption: function(){
            if('self' != this.getShippingType()){
                this.deadlineBlock.show();
            }else{
                this.deadlineBlock.hide();
            }
        },
        validateCnpj: function () {
            $.ajax({
                url: '{{ path('order_cnpj_validate') }}',
                data: {cnpj:$('#order_billingCnpj').val()},
                complete: function (xhr) {
                    if (xhr.status != 200) {
                        toastr.error('CNPJ inválido', '', {
                            positionClass: 'toast-top-center',
                            progressBar: true,
                            preventDuplicates: true
                        });
                    }
                }
            });
        },
        init: function(){

            var checkShippingTypePresence = window.setInterval(function() {
                InfoManager.shippingSelector = $('#shipping_type');
                if (InfoManager.shippingSelector.length) {
                    clearInterval(checkShippingTypePresence);
                    InfoManager.shippingSelector.on('change', function() {
                        InfoManager.checkShippingOption();
                    });
                    InfoManager.checkShippingOption();
                }
            }, 500);

            if (this.billingDirect.attr('checked')) {
                this.billing_direct_inputs.removeClass('hide');
                $('#order_billingCnpj').attr('required','required');
            }

            setTimeout(function () {
                $('#order_billingCnpj').mask("00.000.000/0000-00");
                $("#order_billingPostcode").mask("00000-000");
                $("#order_billingPhone").mask("(00) 00000-0000");
            },1000);

            $('#order_billingCnpj').on('change', function () {
                InfoManager.validateCnpj();
            });

            this.billingDirect.on('change', function () {
                if ($(this).attr('checked')) {
                    $(this).removeAttr('checked');
                    InfoManager.billing_direct_inputs.addClass('hide');
                    $('#order_billingCnpj').removeAttr('required');
                    if (!InfoManager.editable)
                        $('#form_order_info').submit();
                }
                else {
                    $(this).attr('checked','checked');
                    InfoManager.billing_direct_inputs.removeClass('hide');
                    $('#order_billingCnpj').attr('required','required');
                    if (!InfoManager.editable)
                        $('#form_order_info').submit();
                }
            })
        },
        changeEditable: function(editable) {

            if (editable) {
                $(buttonAccount).removeClass('hide');
                $(buttonEdit).addClass('hide');

                $('#order_note').removeAttr('readonly');
                $('#delivery_at').removeAttr('readonly disabled');
                $('#clear_date').removeAttr('disabled');
                $('#order_deliveryDelay').removeAttr('readonly disabled');
                $('#order_deadline').removeAttr('readonly disabled');
                $('#order_paymentMethod').removeAttr('readonly disabled');
                $('#order_expireDays').removeAttr('readonly');

                $('.billing').removeAttr('readonly');

                GeneratorHandler.enableValidate ++;
                GeneratorHandler.btnValidate.addClass('hide');
            } else {
                $(buttonAccount).addClass('hide');
                $(buttonEdit).removeClass('hide');

                $('#order_note').attr('readonly', 'readonly');
                $('#delivery_at').attr('readonly', 'readonly');
                $('#clear_date').attr('disable', 'disable');
                $('#order_deliveryDelay').attr('readonly', 'readonly');
                $('#order_deadline').attr('readonly', 'readonly');
                $('#order_paymentMethod').attr('readonly', 'readonly');
                $('#order_expireDays').attr('readonly', 'readonly');

                $('.billing').attr('readonly', 'readonly');

                GeneratorHandler.enableValidate --;
                if (!GeneratorHandler.enableValidate)
                    GeneratorHandler.btnValidate.removeClass('hide');
            }
        }
    };

    InfoManager.init();

    $('#form_order_info').on('submit', function (event) {
        event.preventDefault();

        buttonAccount.ladda();
        buttonAccount.ladda('start');

        var form = $(this);
        $.ajax({
            url: form.attr('action'),
            method: form.attr('method'),
            data: form.serialize(),
            complete: function (xhr) {
                if (200 != xhr.status) {
                    swal('Ooops', 'Falha ao executar a operação.', 'error');
                }

                buttonAccount.ladda('stop');
                if (InfoManager.clickByPayment) {
                    InfoManager.editable = false;
                    InfoManager.changeEditable(false);
                    InfoManager.clickByPayment = false;
                }

                $('#order_paymentMethod').attr('disabled', 'disabled');
                $('#delivery_at').attr('disabled', 'disabled');
                $('#clear_date').attr('disabled', 'disabled');
                $('#order_deliveryDelay').attr('disabled', 'disabled');
                $('#order_deadline').attr('disabled','disabled');
            }
        });
    });

    $('#order_billingPostcode').on('change', function () {
        var postcode = $(this).val();
        $.ajax({
            url: '{{ path('utils_postcode') }}',
            method: 'post',
            data: {postcode: postcode},
            complete: function (xhr) {
                if (xhr.status == 200 && xhr.responseJSON.status == 200) {
                    var response = xhr.responseJSON;
                    $('#order_billingState').val(response.state);
                    $('#order_billingCity').val(response.city);
                    $('#order_billingDistrict').val(response.neighborhood);
                    $('#order_billingStreet').val(response.street);
                }
            }
        });
    });

    $('#order_postcode').on('change', function () {
        var postcode = $(this).val();
        $.ajax({
            url: '{{ path('utils_postcode') }}',
            method: 'post',
            data: {postcode: postcode},
            complete: function (xhr) {
                if (xhr.status == 200 && xhr.responseJSON.status == 200) {
                    var response = xhr.responseJSON;
                    $('#order_state').val(response.state);
                    $('#order_city').val(response.city);
                    $('#order_district').val(response.neighborhood);
                    $('#order_address').val(response.street);
                }
            }
        });
    });

    var sourceDeliveryAt = $('#delivery_at');

    sourceDeliveryAt.daterangepicker({
        startDate: '{{ order.deliveryAt ? order.deliveryAt|date('d/m/Y') : 'now'|date_modify("+3 day")|date('d/m/Y') }}',
        singleDatePicker: true,

        minDate: moment(),
        locale: {
            format: 'DD/MM/YYYY',
            daysOfWeek: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
            monthNames: [
                "Janeiro",
                "Fevereiro",
                "Março",
                "Abril",
                "Maio",
                "Junho",
                "Julho",
                "Agosto",
                "Setembro",
                "Outubro",
                "Novembro",
                "Dezembro"
            ]
        }
    }).on('change', function(event, picker){
        InfoManager.setDeliveryAt(sourceDeliveryAt.val());
    });

    {% if not order.deliveryAt %}
    sourceDeliveryAt.val('');
    {% endif %}


    $('#clear_date').on('click', function () {
        sourceDeliveryAt.val('');
        InfoManager.setDeliveryAt(sourceDeliveryAt.val());
    });
</script>
