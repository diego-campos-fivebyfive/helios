{% extends view('layout') %}

{% block body %}

    <style>
        .collapse {
            display: none;
        }
        .color-rows {
            color: #676a6c;
        }
        .table-components {
            border: solid 1px #d3d3d3;
        }
        .row-total {
            display: block;
        }
        .spacing {
            margin-top: 8px;
        }
        .spacing-bottom {
            margin-bottom: 8px;
        }
        .minimize {
            background-color: #EEE;
        }
        .btn.btn-status{
            background-color: #f2f2f2;
            border: 1px solid #b2b2b2;
            color: #555;
        }
        .btn.status-building i{  color: #898989;  }
        .btn.status-pending i{  color: #ff7701;  }
        .btn.status-validated i{  color: #0a6aa1;  }
        .btn.status-approved i{  color: #00a157;  }
        .btn.status-rejected i{  color: #ffcd70;  }
        .btn.status-done i{  color: #777;  }
        .btn-green, .btn-green:hover, .btn-green:focus {
            background-color: #dff0d8;
            color: #3c763d;
            border-color: #a7e1a1;
        }
        .btn-orange, .btn-orange:hover, .btn-orange:focus {
            background-color: #fab966;
            color: #222;
            border-color: #FFA54E;
        }
    </style>

    {% set orders = order.childrens %}
    <div class="wrapper wrapper-content  animated fadeInRight">
        <div class="row">

            <div class="col-md-12">
                {% if not member.isPlatformUser %}
                    {% if order.validated %}
                        <div class="alert alert-danger">
                            <i class="fa fa-warning"></i>
                            Ao editar este orçamento será necessário uma revalidação pela equipe da Sices.
                        </div>
                        <div class="alert alert-success">
                            <i class="fa fa-info-circle"></i>
                            Ao aprovar este orçamento você receberá a proforma e seu pedido de compra será
                            processado.
                        </div>
                    {% endif %}
                {% endif %}
            </div>

            <div class="ibox border-bottom">
                <div class="ibox-content">
                    <div class="tab-content">
                        <div class="tab-pane active">
                            <div class="row">
                                <div class="row wrapper">
                                    <div class="col-md-12 border-bottom">
                                        <div class="btn-group spacing-bottom">

                                            <span class="btn btn-sm btn-status status-{{ order.statusName }}">
                                                <i class="fa fa-circle"></i> {{ order.statusName|capitalize|trans }}
                                            </span>

                                            {% if order.isBuilding %}
                                                <a class="btn btn-sm btn-danger" href="#">
                                                    <i class="fa fa-close"></i> Excluir
                                                </a>
                                            {% endif %}

                                            {% if member.isPlatformUser %}
                                                {% if order.isPending %}
                                                    <a class="btn btn-sm btn-green" data-id="{{ order.id }}"
                                                       data-status="{{ constant('AppBundle\\Entity\\Order\\Order::STATUS_VALIDATED') }}">
                                                        <i class="fa fa-check"></i> Validar
                                                    </a>
                                                {% endif %}
                                            {% endif %}

                                            {% if not member.isPlatformUser %}
                                                {% if order.isValidated %}
                                                    <a class="btn btn-sm btn-green" data-id="{{ order.id }}"
                                                       data-status="{{ constant('AppBundle\\Entity\\Order\\Order::STATUS_APPROVED') }}">
                                                        <i class="fa fa-thumbs-o-up"></i> Aprovar
                                                    </a>
                                                    <a class="btn btn-sm btn-orange" data-id="{{ order.id }}"
                                                       data-status="{{ constant('AppBundle\\Entity\\Order\\Order::STATUS_REJECTED') }}">
                                                        <i class="fa fa-thumbs-o-down"></i> Rejeitar
                                                    </a>
                                                {% endif %}
                                            {% endif %}

                                            {% if member.isPlatformFinancial %}
                                                {% if order.isApproved %}
                                                    <a class="btn btn-sm btn-green" data-id="{{ order.id }}"
                                                       data-status="{{ constant('AppBundle\\Entity\\Order\\Order::STATUS_DONE') }}">
                                                        <i class="fa fa-check-square-o"></i> Pagamento confirmado
                                                    </a>
                                                    <a class="btn btn-sm btn-orange" data-id="{{ order.id }}"
                                                       data-status="{{ constant('AppBundle\\Entity\\Order\\Order::STATUS_REJECTED') }}">
                                                        <i class="fa fa-warning"></i> Pagamento não confirmado
                                                    </a>
                                                {% endif %}
                                            {% endif %}

                                        </div>
                                        <div class="pull-right">

                                            {% if not (order.isDone or order.isApproved or order.isRejected)
                                            and (order.isBuilding or (order.isPending and member.isPlatformUser) or (order.isValidated and not member.isPlatformUser)) %}
                                                <a class="btn btn-sm btn-success pull-right" href="{{ path('project_generator', {order:order.id}) }}">
                                                    <i class="fa fa-pencil"></i> Editar Orçamento
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-12 border-bottom">
                                        <h2>Orçamento</h2>
                                    </div>
                                    <div class="col-lg-12 border-bottom">
                                        <ol class="breadcrumb">
                                            <li>
                                                <label>Dados do integrador</label>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Cliente</label>
                                        {{ order.customer }}
                                    </div>
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">CNPJ</label>
                                        {{ order.cnpj }}
                                    </div>
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Inscrição Estadual</label>
                                        {{ order.ie }}
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Contato</label>
                                        {{ order.contact }}
                                    </div>
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Email</label>
                                        {{ order.email }}
                                    </div>
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Telefone</label>
                                        {{ order.phone }}
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="col-md-3 spacing">
                                        <label class="row-total">Cep</label>
                                        {{ order.postcode }}
                                    </div>
                                    <div class="col-md-1 spacing">
                                        <label class="row-total">Estado</label>
                                        {{ order.state }}
                                    </div>
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Cidade</label>
                                        {{ order.city }}
                                    </div>
                                    <div class="col-md-4 spacing">
                                        <label class="row-total">Endereço</label>
                                        {{ order.address }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            {% if order.shippingrules and order.shippingrules['type'] == 'self' and order.shippingRules.company is not null %}

                    <div class="ibox border-bottom">
                        <div class="ibox-content">
                            <div class="tab-content">
                                <div class="tab-pane active">
                                    <div class="row">
                                        <div class="row wrapper">
                                            <div class="col-lg-12 border-bottom">
                                                <ol class="breadcrumb">
                                                    <li>
                                                        <label>Dados da transportadora</label>
                                                    </li>
                                                </ol>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Razão Social</label>
                                                {{ order.shippingrules['company']['name'] }}
                                            </div>
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">CNPJ</label>
                                                {{ order.shippingrules['company']['cnpj'] }}
                                            </div>
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Inscrição Estadual</label>
                                                {{ order.shippingrules['company']['ie'] }}
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Contato</label>
                                                {{ order.shippingrules['company']['contact'] }}
                                            </div>
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Email</label>
                                                {{ order.shippingrules['company']['email'] }}
                                            </div>
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Telefone</label>
                                                {{ order.shippingrules['company']['phone'] }}
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="col-md-3 spacing">
                                                <label class="row-total">Cep</label>
                                                {{ order.shippingrules['company']['postcode'] }}
                                            </div>
                                            <div class="col-md-1 spacing">
                                                <label class="row-total">Estado</label>
                                                {{ order.shippingrules['company']['state'] }}
                                            </div>
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Cidade</label>
                                                {{ order.shippingrules['company']['city'] }}
                                            </div>
                                            <div class="col-md-4 spacing">
                                                <label class="row-total">Endereço</label>
                                                {{ order.shippingrules['company']['address'] }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

            {% endif %}

            <div class="ibox border-bottom">
                <div class="ibox-content">
                    <div class="tab-content">
                        <div class="tab-pane active">
                            <table class="table table-striped table-hover">
                                <thead>
                                <tr>
                                    <th class="col-md-5"> Descrição </th>
                                    <th class="col-md-2 text-center"> Data </th>
                                    <th class="col-md-1 text-center"> Qtde Itens </th>
                                    <th class="col-md-2"> <span class="pull-right">Valor dos equipamentos</span> </th>
                                    <th class="col-md-2"> <span class="pull-right">Valor do seguro</span> </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for order in orders if not order.budget %}
                                    <tr>
                                        <td colspan="5">
                                            <div>
                                                <h4>
                                                    <a data-toggle="collapse" href="#{{ order.id }}">
                                                        <span class="col-md-5 color-rows"> {{ order.description }} </span>
                                                        <span class="col-md-2 color-rows text-center"> {{ order.createdAt|date('d/m/Y') }} </span>
                                                        <span class="col-md-1 color-rows text-center"> {{ order.elements.count }} Itens</span>
                                                        <span class="col-md-2 color-rows"> <span class="pull-right">{{ order.subTotal|currency }}</span> </span>
                                                        <span class="col-md-2 color-rows"> <span class="pull-right">{{ order.insurance|currency }}</span> </span>
                                                    </a>
                                                </h4>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr >
                                        <td colspan="5" style="padding: 0;">
                                            <div id="{{ order.id }}" class="collapse">
                                                <div>
                                                    <table class="table table-striped table-components">
                                                        <thead>
                                                        <tr>
                                                            <td><b>ITEM</b></td>
                                                            <td class="col-md-2"><b>CÓDIGO</b></td>
                                                            <td class="col-md-5"><b>PRODUTO</b></td>
                                                            <td class="col-md-1 text-center"><b>QTD</b></td>
                                                            <td class="col-md-2 text-center"><b>VALOR UNIT</b></td>
                                                            <td class="col-md-2 text-center"><b>VALOR TOTAL</b></td>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for element in order.elements %}
                                                            <tr>
                                                                <td class="text-center"><b>{{ loop.index }}</b></td>
                                                                <td>{{ element.code }}</td>
                                                                <td>{{ element.description }}</td>
                                                                <td class="text-center">{{ element.quantity }}</td>
                                                                <td class="text-center">{{ element.unitPrice|currency }}</td>
                                                                <td class="text-center">{{ element.total|currency }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    {% if order.insurance %}
                                                        <div class="col-md-12 border-bottom">
                                                        <h4 class="pull-right">Seguro: {{ order.insurance|currency }}</h4>
                                                        </div>
                                                    {% endif %}
                                                    <a data-toggle="collapse" href="#{{ order.id }}" class="color-rows">
                                                        <div class="col-md-12 text-center minimize">
                                                            <i class="fa fa-chevron-up"></i>
                                                        </div>
                                                    </a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <h4>Frete: {% if order.shippingrules and order.shippingrules.type == "sices" %} {{ order.shippingrules.value|currency }} {% else %} Não Incluso {% endif %}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('[data-status]').on('click', function () {
            var id = $(this).data('id');
            var status = $(this).data('status');

            swal({
                title: 'Confirma a operação?',
                text: 'Este processo não pode ser desfeito',
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: '{{ 'Confirmar'|trans }}',
                cancelButtonText: '{{ 'Cancelar'|trans }}',
                closeOnConfirm: false
            }, function () {

                $.ajax({
                    url: '{{ path('order_status',{id:'_id_'}) }}'.replace(/_id_/g, id),
                    method: 'post',
                    data: {status: status},
                    complete: function (xhr) {

                        if (200 == xhr.status) {

                            swal({
                                title: "Concluído.",
                                text: "Operação realizada com sucesso.",
                                type: "success",
                                showConfirmButton: false
                            });

                            window.setTimeout(function () {
                                swal.close();
                                window.location.reload();
                            }, 1500);

                        } else {
                            var response = xhr.responseJSON;
                            swal('Ooops', response.hasOwnProperty('error') ? response.error : 'Falha ao executar a operação', 'error');
                        }
                    },
                    beforeSend: function () {
                        swal({
                            title: "Processando...",
                            text: "Aguarde.",
                            type: "info",
                            showConfirmButton: false
                        });
                    }
                });

            });
        });
    </script>
{% endblock %}
