{% set accessDiscount = app.user.isPlatformAdmin or app.user.isPlatformMaster %}
{% set userExpanse = app.user.isPlatformExpanse %}

<div class="row" id="coupon_form">
</div>

<div class="hr-line-dashed col-md-12"></div>

{{ form_start(form, {attr:{id:'form_discount', action: app.request.uri}}) }}
<div class="row">
    <div class="col-md-12">
        <h3>Desconto:</h3>
        {% if accessDiscount %}
            <div class="form-group col-md-3">
                {{ form_label(form.target, 'Opção de Desconto') }}
                {{ form_widget(form.target,{attr:{class:'form-control'}}) }}
            </div>
        {% endif %}

        <div class="form-group col-md-3">
            {{ form_label(form.value, 'Valor do Desconto') }}
            {{ form_widget(form.value,{attr:{class:'form-control'}}) }}
        </div>

        <div class="form-group col-md-2 pull-right">
            <label> &nbsp; </label>
            <button class="btn btn-success btn-block ladda-button" id="submit_discount" data-style="zoom-in" type="submit">
                <i class="fa fa-check-circle-o"></i> Aplicar
            </button>
        </div>

        <div class="hide">
            {{ form_rest(form) }}
        </div>
    </div>
</div>
{{ form_end(form) }}

{% include view('helper.request') %}
<script>

    var FormCoupon = $('#coupon_form');

    $.ajax({
      url: "{{ path('coupon_create', {id:order.id}) }}",
      success: function (response) {
        FormCoupon.html(response);
      }
    });

    var FormDiscount = $('#form_discount');

    FormDiscount.on('submit', function (event) {
        event.preventDefault();
        var url = $(this).attr('action');

        Request.send({
            url: url,
            data: FormDiscount.serialize(),
            method: 'POST',
            callback: function (xhr) {
                var response = xhr.responseJSON;
                if (response.orderDiscount > 0)
                    $('#discount_info').removeClass('hide');
                else
                    $('#discount_info').addClass('hide');
                $('#order-discount').html('-'+numeral(response.orderDiscount).format('$0,0.00'));
                $('#order-total').html(numeral(response.total).format('$0,0.00'));
            }
        });
    });

    if ({{ userExpanse ? 'true': 'false' }}) {

        var Discount = $('#discount_value');
        Discount.on('blur', function () {
            var value = $(this).val();
            var maxDiscount = {{ maxDiscount }};

            value = (maxDiscount < value) ? maxDiscount : value;
            Discount.val(value);
        });

    }

    var custom_mask = function(element){
        element.on('keyup', function(){
            sanitize(element);
        });
    };

    var sanitize = function(element){
        function clear(v){ return v.replace(/\D+/g,''); }
        var value = element.val();
        var backup = value.replace(/\./g,',');
        value = clear(value);
        if(backup.indexOf(',') > 0){
            var commas = backup.split(',');
            value = clear(commas[0])+',';
            if(commas[1].length){
                value += clear(commas[1]);
            }
        }
        if(0 == backup.indexOf('-')){
            if(2 == backup.split('-').length){
                value = '-' + value;
            }
        }
        element.val(value);
    };

    var common_mask = {pattern: '##,##', reverse: true};
    var targets = {
        'discount_value': common_mask,
    };

    $.each(targets, function (id, options) {
        custom_mask($('#'+id));
    });

</script>
