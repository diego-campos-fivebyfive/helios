<div class="button-group" title="Estado" id="filter-state">
    <button
            type="button"
            class="form-control selected dropdown-toggle"
            data-toggle="dropdown">
        Estado
        <span class="caret"></span>
    </button>
    <ul class="dropdown-menu"  style="max-height: 250px; overflow: auto">
        {% for key, state in states %}
            <li>
                <a href="#" class="small" data-value="{{ key }}" tabIndex="-1">
                    <input value="{{ key }}" type="checkbox" {% if state.checked %}checked{% endif %}>
                    {{ state.name }}
                </a>
            </li>
        {% endfor %}
    </ul>
</div>
<script>
    var filter_state = $('#filter-state');

    function StateFilter(form_filtration) {
      $filterStatesHasChanges = false;

      function getStates() {
        var options = $('.button-group .dropdown-menu a');
        var states = [];

        Array
          .from(options)
          .forEach(function (option) {
            var key = option.getAttribute('data-value');
            var checked = option.querySelector('input').checked;

            if (checked) {
              states.push(key);
            }
          });

        return states;
      }

      function filterStates() {
        $('.dropdown-menu').on('click', function(event) {
          $filterStatesHasChanges = true;
          event.stopPropagation();
        });

        $(document).one('click', function(event) {
          document.removeEventListener('click', filterStates);

          if ($filterStatesHasChanges) {
            $('input[name="states"]').val(getStates());
            form_filtration.trigger('submit');
            $filterStatesHasChanges = false;
          }
        });
      }

      filter_state.on('click', function() {
        document.addEventListener('click', filterStates);
      });
    }
</script>
