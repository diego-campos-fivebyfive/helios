<script src="https://socket-io-chat.now.sh/socket.io/socket.io.js"></script>
<script>
    {# general scripts #}
    $(function () {
        var socket = io('{{ platform_host }}:{{ socket_port }}/socket?token={{ app.user.info.token }}');
        var beepSound = new Audio("{{ asset('assets/sound/beep_messages.wav') }}");

        socket.on('updateTotalOfMessages', function(data) {
          var totalOfMessages = Number($('#unreadMessages').html()) + data;
          $('#unreadMessages').html(totalOfMessages);
          $('#unreadMessages').show();
          beepSound.play();
        });

        {% for notice in app.request.session.flashBag.get('notice') %}
        toastr.{{ notice.type }}('{{ notice.message }}', '{{ notice.title }}', {
            positionClass: 'toast-top-center',
            progressBar: true
        });
        {% endfor %}
    });

    function getUnreadMessageCount() {
        $.ajax({
            type: "get",
            url: "{{ route('unread_message_count') }}",
            success: function(response) {
                var unreadMessages = response.unreadMessages;

                $('#unreadMessages').html(unreadMessages);

                if (unreadMessages) {
                    $('#unreadMessages').show();
                } else {
                    $('#unreadMessages').hide();
                }
            }
        });
    }

    {% if app.user.isPlatform %}
        getUnreadMessageCount();
    {% else %}
        var key =  "{{ app.user.info.token }}-terms";

        var uri = window.location;

        var uncheckedPaths = [
            '/notice/terms'
        ];

        function checkTermsRequest() {
            $.ajax({
                type: "get",
                url: "{{ route('checker_terms') }}",
                complete: function(response) {
                    if(window.self !== window.top) {
                        return;
                    }

                    if (response.status === 401) {
                        window.location = response.responseJSON.url;
                    }

                    if (response.status === 200) {
                        localStorage.setItem(key, new Date().getTime());
                    }
                }
            });
        }

        function checkTerms() {
            var checkedTermsTime = localStorage.getItem(key);
            var checkTermsInterval = 300000;

            if (!checkedTermsTime || (new Date().getTime() - checkedTermsTime) > checkTermsInterval) {
                checkTermsRequest();
            }
        }

        if (uncheckedPaths.indexOf(uri.pathname) === -1) {
            checkTerms();
        }
    {% endif %}

    var Realtime = {
        tasks: {
            menu: function () {
                var task_menu = $('a[href="{{ path('task_index') }}"]');
                if (task_menu.length) {
                    task_menu = task_menu.first();
                    $.ajax({
                        url: '{{ path('tasks_count') }}',
                        complete: function (xhr) {
                            if (200 == xhr.status) {
                                var response = xhr.responseJSON;
                                if (response.count) {
                                    var counter = $('#tasks-count');
                                    if (counter.length) {
                                        counter.html(response.count);
                                    } else {
                                        task_menu.append('<span id="tasks-count" class="label label-warning">' + response.count + '</span>')
                                    }
                                }
                            }
                        }
                    });
                }
            }
        },
        online: function () {
            $.ajax({
                url: '{{ path('app_check_online') }}',
                complete: function (xhr) {
                    var response = xhr.responseJSON;
                    if(response && !response.online && 'undefined' != typeof woopra){
                        woopra.track();
                    }
                }
            });
        }
    };

    {% if app.request.attributes.get('_route') != 'task_index' %}
        Realtime.tasks.menu();
    {% endif %}

    Realtime.online();
</script>
