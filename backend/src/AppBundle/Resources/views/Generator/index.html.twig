{% extends view('layout') %}

{% block before_styles %}
    {% include view('helper.plugins_css') %}
{% endblock %}

{% block body %}

    <style>
        #generator_container,
        #generator_container li{
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .nav > li {
            position: relative;
            display: block;
            border-radius: 10px;
        }

        .nav > li.active {
            border-left: none;
            background: #293846;
        }

        .tab-content > ul.pager {
            width: 400px;
        }

        .tab-content > ul.pager li > a, .tab-content > ul.pager li > span {
            display: inline-block;
            padding: 5px 14px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

    </style>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Orçamentos</h5>
                </div>
                <div class="ibox-content">
                    <div id="rootwizard">
                        <div class="navbar">
                            <div class="navbar-inner">
                                <div class="container">
                                    <ul>
                                        <li><a href="#tab1" data-toggle="tab">Gerador</a></li>
                                        <li><a href="#tab2" data-toggle="tab">Orçamento Atual</a></li>
                                        <li><a href="#tab3" data-toggle="tab">Lista de Sistemas</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="tab-content">
                            <div class="tab-pane" id="tab1">
                                <div class="panel panel-info">
                                    <div class="panel-heading" id="info_power">
                                        Gerador
                                    </div>
                                    <div class="panel-body">

                                        <div id="generator_form" class="col-md-12 flow-h">
                                        </div>

                                        <div id="generator_components" class="col-md-12 flow-h">
                                        </div>

                                    </div>
                                </div>

                                <div id="generator_config">
                                </div>
                            </div>
                            <div class="tab-pane" id="tab2">
                                <div id="generator_orders" class="col-md-12 flow-h">
                                </div>
                            </div>
                            <div class="tab-pane" id="tab3">
                                <div class="col-md 12">

                                </div>
                            </div>
                            <ul class="pager wizard">
                                <li class="previous"><a href="javascript:;">voltar</a></li>
                                <li class="next"><a href="javascript:;" id="add_project_to_order" class="btn btn-primary pull-right previous">
                                        Adicionar ao orçamento atual <i class="fa fa-arrow-right"></i>
                                    </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            {#<div id="generator_config">
            </div>

            <div class="hr-line-dashed col-md-12"></div>

            <div id="generator_orders" class="col-md-12 flow-h">
            </div>#}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

    {% include view('helper.request') %}
    {% include view('helper.plugins_js') %}
    {% include view('helper.numbers') %}
    {% include view('helper.wizard') %}

    <script>

        var orderId = {{ order.id }};

        GeneratorHandler = {
            project: {id:0,power:0},
            resetGenerator: function () {
                $('#generator_config').html('');
                $('#info_power').html('Gerador');
            },
            getProject: function(){
                return this.project;
            },
            resetProject: function(){
                this.project = {id:0,power:0};
                this.onResetProject();
            },
            getForm: function(){
                var id = this.getProject().id;
                Request.send({
                    url: '{{ path('generator',{project:'_id_'}) }}'.replace(/_id_/g, id),
                    callback: function(xhr){
                        $('#generator_form').html(xhr.responseText);
                        FormGenerator.field('source').find('option[value="power"]').attr('selected', 'selected').trigger('change');
                        var blocks = FormGenerator.form.find('.middle-block');
                        $(blocks[0]).hide();
                        $(blocks[1]).addClass('col-md-12');
                    }
                });
            },
            setPower: function(power) {
                $('#info_power').html('Sistema de '+power+' kWp');
            },
            getComponents: function(){
                var id = this.getProject().id;
                if(id){
                    Request.send({
                        url: '{{ path('generator_components',{id:'_id_'}) }}'.replace(/_id_/g, id),
                        callback: function(xhr){

                            $('#generator_components').html(xhr.responseText);

                            Request.send({
                                url: '{{ path('generator_position',{id:'_id_'}) }}'.replace(/_id_/g, id),
                                callback: function(xhr){
                                    $('#generator_config').html(xhr.responseText);
                                }
                            });

                        }
                    });
                }
            },
            getOrders: function(){
                Request.send({
                    url: '{{ path('generator_orders') }}',
                    callback: function(xhr){
                        $('#generator_orders').html(xhr.responseText);
                    }
                });
            },
            onSaveProject: function(project){
                this.project = project;
                this.getComponents();
                this.getForm();
            },
            onResetProject: function(){
                $('#generator_components').html('');
            },
            onSaveOrder: function(){
                this.getOrders();
                this.resetProject();
                this.getForm();
            },
            init: function(){
                this.getForm();
                this.getComponents();
                this.getOrders();
            }
        };

        GeneratorHandler.init();

        $('#add_project_to_order').on('click', function () {
            var id = GeneratorHandler.getProject().id;
            if (id) {
                swal({
                    title: 'Confirma a geração do orçamento?',
                    text: 'Após este processo o projeto atual será removido!',
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: '{{ 'Confirmar'|trans }}',
                    cancelButtonText: '{{ 'Cancelar'|trans }}',
                    closeOnConfirm: false
                }, function () {

                    sweetAlert({
                        title: "Gerando orçamento...",
                        text: "Aguarde!",
                        type: "info",
                        showConfirmButton: false
                    });

                    Request.send({
                        url: '{{ path('generator_orders_create',{id:'_id_'}) }}'.replace(/_id_/g, id),
                        method: 'post',
                        callback: function (xhr) {
                            ShippingManager.calculate();
                            GeneratorHandler.onSaveOrder();
                            GeneratorHandler.resetGenerator();
                            swal.close();
                        }
                    });
                });
            }
        });

        $(document).ready(function() {
            $('#rootwizard').bootstrapWizard({onTabShow: function(tab, navigation, index) {
                var $total = navigation.find('li').length;
                var $current = index+1;
                var $percent = ($current/$total) * 100;
                $('#rootwizard').find('.bar').css({width:$percent+'%'});
            }});
            $('#rootwizard .finish').click(function() {
                alert('Finished!, Starting over!');
                $('#rootwizard').find("a[href*='tab1']").trigger('click');
            });
        });

</script>

{% endblock %}
