<style>
    .cart-product-imitation {
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
    }

    .item-right {
        margin-right: 10px;
    }
</style>

<div class="row">
    <div class="col-md-9">
        <div class="ibox">
            <div class="ibox-title">
                {% if kits %}
                    <a data-remove="{{ path('clear_cart') }}"
                       class="btn btn-danger btn-xs pull-right item-right">
                        <i class="fa fa-trash"></i> Limpar o carrinho
                    </a>
                {% endif %}
                <span class="pull-right item-right">(<strong>{{ kitsQuantity }}</strong>) item(s)</span>
                <h5>Item(s) no seu carrinho</h5>
            </div>
            <div class="ibox-content">
                <div class="table-responsive">
                    <table class="table shoping-cart-table">
                        <tbody>
                        {% for kit in kits%}
                            <tr>
                                <td width="90">
                                    <div class="cart-product-imitation" style="background-image: url({{ kit.kit.image|componentFilePath }})">
                                    </div>
                                </td>
                                <td class="desc">
                                    <h3>
                                        <a data-url="{{ path('kit_show', { id: kit.kit.id }) }}"
                                           data-toggle="modal"
                                           data-target="#modal_details"
                                           class="text-navy modal_open">
                                            {{ kit.kit.code }}
                                        </a>
                                    </h3>
                                    <p class="small">
                                        {{ kit.kit.description }}
                                    </p>

                                    <div class="m-t-sm">
                                        <a data-delete="{{ path('cart_remove_kit', { id: kit.kit.id}) }}"
                                           class="btn btn-danger btn-xs">
                                            <i class="fa fa-trash"></i> Remover Kit
                                        </a>
                                    </div>
                                </td>

                                <td>
                                    R${{ kit.kit.price|number_format(2, ',', '.') }}
                                </td>
                                <td width="65">
                                    <input class="form-control" placeholder="1" type="text" data-quantity="{{ path('quantity_kit', { id: kit.kit.id }) }}" value="{{ kit.quantity }}">
                                </td>
                                <td>
                                    <h4>
                                        R${{ kit.total|number_format(2, ',', '.') }}
                                    </h4>
                                </td>
                            </tr>
                        {% else %}
                            <p>Nenhum item no carrinho.</p>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="ibox-content">
                <a href="{{ path('cart_checkout') }}" class="btn btn-primary pull-right"><i class="fa fa fa-shopping-cart"></i> Checkout </a>
                <a href="{{ path('index_kit') }}" class="btn btn-white"><i class="fa fa-arrow-left"></i> Continuar comprando </a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="ibox">
            <div class="ibox-title">
                <h5>Sumário do Carrinho</h5>
            </div>
            <div class="ibox-content">
                <span>
                    Total
                </span>
                <h2 class="font-bold">
                    R$ {{ total|number_format(2, ',', '.') }}
                </h2>
                <hr>
                <div class="m-t-sm">
                    <div class="btn-group">
                        <a href="{{ path('cart_checkout') }}" class="btn btn-primary btn-sm"><i class="fa fa-shopping-cart"></i> Checkout</a>
                        <a href="{{ path('index_kit') }}" class="btn btn-white btn-sm"> Cancelar </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var detail_kit = $('#detail_kit');
    $('[data-target="#modal_details"]').on('click', function() {
        var url = $(this).data('url');
        if (url) {
            $('#e_modal_details').modal('show');
            $.ajax({
                url: url,
                method: 'get',
                success: function (response) {
                    detail_kit.html(response);
                }
            });
        } else {
            detail_kit.html('<h1> Nenhum kit selecionado para visualização </h1>');
        }
    });

    var dataDelete = $('[data-delete]');
    if(dataDelete.length){
        dataDelete.on('click', function () {
            var url = $(this).data('delete');
            swal({
                title: "Confirma a remoção deste Kit?",
                text: null,
                type: "info",
                showCancelButton: true,
                cancelButtonText: "{{ 'Cancel'|trans }}",
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "{{ 'Confirm'|trans }}",
                closeOnConfirm: false
            }, function () {
                swal.close();
                $.ajax({
                    url: url,
                    method: 'post',
                    data: {_method:'delete'},
                    complete: function (xhr) {
                        if (200 == xhr.status) {
                            swal("", 'Kit removido com sucesso', "success");
                        } else {
                            swal("Oops!",'Erro ao remover este kit', "error");
                        }

                        loadItemsCart();
                    },
                    beforeSend: function () {
                        swal({
                            title: "Removendo...",
                            text: "Aguarde",
                            type: "info",
                            showConfirmButton: false
                        });
                    }
                });
            });
        });
    }

    var dataRemove = $('[data-remove]');
    if(dataRemove.length){
        dataRemove.on('click', function () {
            var url = $(this).data('remove');
            swal({
                title: "Confirma  a remoção dos kits do carrinho?",
                text: null,
                type: "info",
                showCancelButton: true,
                cancelButtonText: "{{ 'Cancel'|trans }}",
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "{{ 'Confirm'|trans }}",
                closeOnConfirm: false
            }, function () {
                swal.close();
                $.ajax({
                    url: url,
                    method: 'post',
                    data: {_method:'delete'},
                    complete: function (xhr) {
                        if (200 == xhr.status) {
                            swal("", "Kits removidos com sucesso", "success");
                            window.setTimeout(function(){
                                swal.close();
                            }, 1000);
                        } else {
                            swal("Oops!", "Erro ao remover os kits do carrinho", "error");
                        }

                        loadItemsCart();
                    },
                    beforeSend: function () {
                        swal({
                            title: "Limpando o carrinho...",
                            text: "Aguarde",
                            type: "info",
                            showConfirmButton: false
                        });
                    }
                });
            });
        });
    }

    $('[data-quantity]').on('change', function () {

        var url = $(this).data('quantity');
        var quantity = $(this).val();

        $.ajax({
            url: url,
            data: {quantity: quantity},
            method: 'put',
            complete: function (xhr) {
                if(200 === xhr.status){
                    toastr.success('Quantidade atualizada com sucesso', '{{ 'Success'|trans }}', {
                        positionClass: 'toast-top-center',
                        progressBar: true,
                        preventDuplicates: true
                    });
                }else{
                    var response = xhr.responseJSON;
                    toastr.error(response.message, '{{ 'Error'|trans }}', {
                        positionClass: 'toast-top-center',
                        progressBar: true,
                        preventDuplicates: true
                    });
                }

                loadItemsCart();
            }
        });
    });
</script>
