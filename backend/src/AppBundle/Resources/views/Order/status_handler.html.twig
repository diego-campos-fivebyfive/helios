<script>

    function showSwal(id, status, subStatus, title, text) {
        swal({
            title: title,
            text: text,
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: '{{ 'Confirmar'|trans }}',
            cancelButtonText: '{{ 'Cancelar'|trans }}',
            closeOnConfirm: false
        }, function () {
            $.ajax({
                url: '{{ path('order_status',{id:'_id_'}) }}'.replace(/_id_/g, id),
                method: 'post',
                data: {
                    status: status,
                    subStatus: subStatus
                },
                complete: function (xhr) {

                    if (200 == xhr.status) {

                        swal({
                            title: "Concluído.",
                            text: "Operação realizada com sucesso.",
                            type: "success",
                            showConfirmButton: false
                        });

                        window.setTimeout(function () {
                            swal.close();
                            window.location.reload();
                        }, 1500);

                    } else {
                        var response = xhr.responseJSON;
                        swal('Ooops', response.hasOwnProperty('error') ? response.error : 'Falha ao executar a operação', 'error');
                    }
                },
                beforeSend: function () {
                    swal({
                        title: "Processando...",
                        text: "Aguarde.",
                        type: "info",
                        showConfirmButton: false
                    });
                }
            });
        });
    }

    $('[data-status]').on('click', function () {
        var id = $(this).data('id');
        var status = $(this).data('status');
        var subStatus = $(this).data('substatus');

        var title = 'Confirma a operação?';
        var text = 'Este processo não pode ser desfeito';

        if (status == {{ constant('AppBundle\\Entity\\Order\\Order::STATUS_APPROVED') }}) {
            title = 'Aprovar e gerar pró-forma?';
            text = 'ATENÇÃO: Ao prosseguir você estará confirmando seu pedido, que será processado após a identificação do pagamento.';

            $.ajax({
                url: '{{ path('components_out_of_stock',{id:'_id_'}) }}'.replace(/_id_/g, id),
                method: 'get',
                complete: function (xhr) {
                    if (200 === xhr.status) {

                        var response = xhr.responseText;

                        if (response !== "") {
                            $('#components_out_of_stock').modal('show');
                            $('#components_out_of_stock').find('.modal-body').html(response);
                        }
                        else {
                            showSwal(id, status, subStatus, title, text);
                        }
                    } else {
                        var response = xhr.responseJSON;
                        swal('Ooops', response.hasOwnProperty('error') ? response.error : 'Falha ao executar a operação', 'error');
                    }
                }
            });
        }
        else {
            showSwal(id, status, subStatus, title, text);
        }
    });

</script>
