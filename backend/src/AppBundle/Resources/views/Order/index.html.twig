{% extends view('layout') %}

{% block styles %}

    <style>
        table tbody tr {
            display: table-row !important;
        }
        .label.label-status{
            background-color: #f2f2f2;
            border: 1px solid #b2b2b2;
            color: #555;
        }
        .label.status-building i{  color: #898989;  }
        .label.status-pending i{  color: #ff7701;  }
        .label.status-validated i{  color: #0a6aa1;  }
        .label.status-approved i{  color: #00a157;  }
        .label.status-rejected i{  color: #ffcd70;  }
        .label.status-done i{  color: #777;  }
        .label.status-inserted i {  color: #1aa10f;  }

        .validated {  color: #0a6aa1;  }

        .group-values select {
            float: left;
            width: 30%;
        }

        .group-values input {
            float: left;
            width: 55%;
        }
        .group-input input {
            float: left;
            width: 85%;
        }
        .group-input button {
            width: 15%;
            border-radius: 0  2px 2px 0;
        }
        .chosen-choices {
            border-radius: 1px;
            padding: 2px !important;
        }
        #filter_optionsVal {
            width: 40%;
        }
        #filter_valueMin , #filter_valueMax {
            width: 30%;
        }
        #form-filter {
            margin-bottom: 10px;
        }
    </style>

{% endblock %}

{% block body %}

    <div class="modal inmodal" id="e_modal_details" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content animated bounceInLeft">
                <div class="modal-header">
                    <h4 class="modal-title" id="id_title">
                    </h4>
                </div>
                <div class="modal-body">
                    <div class="form-group hide col-md-12" id="formDelivery">
                    </div>
                    <div class="form-group col-md-12" id="edit_freight">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="bt_save">
                        {{ 'Close'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="modal_upload" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <h4 class="modal-title">
                        <i class="fa fa-file-text"></i> Enviar Comprovante de Pagamento
                    </h4>
                </div>
                <div class="modal-body">
                    {% include view('helper.spinner') %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        <i class="fa fa-close"></i> {{ 'Close'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">

                <div class="col-md-10">
                    {{ form_start(form, {attr:{id:'form-filter'}}) }}
                    <div class="row">

                        <div class="form-group col-md-3">
                            {{ form_widget(form.like,{attr:{class:'form-control', placeholder: 'Referência'}}) }}
                        </div>

                        <div class="group-values col-md-4">
                            {{ form_widget(form.optionsVal,{attr:{class:'form-control'}}) }}
                            {{ form_widget(form.valueMin,{attr:{class:'form-control', placeholder:'Mínimo' }}) }}
                            {{ form_widget(form.valueMax,{attr:{class:'form-control', placeholder:'Máximo' }}) }}
                        </div>

                        <div class="group-input col-md-5">
                            {{ form_widget(form.statusAt,{attr:{class:'form-control', placeholder:'Filtrar p/ data de status' }}) }}
                            <button type="button" id="clear-statusAt" class="btn btn-primary ">
                                <i class="fa fa-eraser"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            {% include view('admin/helper/status_filter.html.twig') %}
                        </div>

                        <div class="col-md-2 pull-right">
                            <button type="submit" class="btn btn-primary btn-md btn-block">
                                <i class="fa fa-search"></i> Pesquisar
                            </button>
                        </div>

                        <div class="hide">
                            {{ form_rest(form) }}
                        </div>
                    </div>
                    {{ form_end(form) }}
                </div>

                <div class="col-md-2">
                    <a class="btn btn-success pull-right" href="{{ path('project_generator') }}">
                        <i class="fa fa-plus"></i> Orçamento
                    </a>
                </div>


            <div class="col-md-12">
                <div class="ibox float-e-margins flow-h">
                    <div class="ibox-title flow-lg">
                        <h5>
                            <i class="fa fa-files-o"> </i> Solicitações
                        </h5>

                        <span class="pull-right small text-muted">
                            {% set count = orders.totalItemCount %}
                            <h4 class="col-md-12">
                                {% if count == 0 %} Nenhuma {% else %} {{ count }} {% endif %}
                                {% if count <= 1 %} Solicitação encontrada {% else %} Solicitações encontradas {% endif %}
                            </h4>
                        </span>

                        <span class="pull-right small text-muted">
                            <h4 class="col-md-12">
                                Valor dos orçamentos: {{ totals.total|currency }}
                            </h4>
                        </span>

                        <span class="pull-right small text-muted">
                            <h4 class="col-md-12">
                                Potência total: {{ totals.power|number_format(2,',','.') }} kWp
                            </h4>
                        </span>

                    </div>

                    <div class="ibox-content flow-lg">
                        <table class="table table-stripped">
                            <thead>
                                <tr>
                                    <td class="col-md-2 text-center">Número</td>
                                    <td class="text-center">Sistemas</td>
                                    <td class="text-center">Status</td>
                                    <td class="text-center">Arquivos</td>
                                    <td class="col-md-2">&nbsp;</td>
                                </tr>
                            </thead>

                            <tbody>
                            {% for item in orders %}
                            {% set order = item %}
                                <tr>
                                    <td class="text-center col-md-2">
                                        <h4>{{ item.reference }}</h4>
                                        <small>{{ item.createdAt|format_date }}</small>
                                    </td>
                                    <td class="text-center ">
                                        <h4>
                                            {% if order.childrens.count %}
                                                {% for children in order.childrens %}
                                                    {{ children.power }}, kWp
                                                {% endfor %}
                                            {% else %}
                                                Sem sistemas
                                            {% endif %}
                                        </h4>
                                        <small> {{ order.total|currency }} </small>
                                    </td>
                                    <td class="text-center">
                                        <h5>
                                            <span class="label label-status status-{{ order.statusName }}">
                                                <i class="fa fa-circle"></i> {{ order.statusName|capitalize|trans }}:
                                                {% if order.statusAt %}
                                                    {{ order.statusAt|date('d/m/Y') }}
                                                {% endif %}
                                            </span>
                                        </h5>
                                        {% if order.deliveryAt %}
                                            <small>
                                                Disponível: {{ order.deliveryAt|date('d/m/Y') }}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center col-md-4">
                                        <div class="btn-group btn-group-sm col-md-12 btn-group-justified">
                                            {% if order.hasProforma %}
                                                <a class="btn btn-default {{ order.proforma ? 'validated' }}" href="{{ path('order_file',{id:order.id, type:'proforma'}) }}"
                                                   target="_blank"> <i class="fa fa-file-pdf-o"></i>
                                                    <br><small>Proforma</small>
                                                </a>
                                            {% else %}
                                                <i class="btn btn-default fa fa-file-pdf-o">
                                                    <br><small>Proforma</small>
                                                </i>
                                            {% endif %}

                                            {% set shippingRules = order.shippingRules %}

                                            {% set shippingInfo = order.isRejected or order.isDone or order.isAvailable or order.isCollected or order.isDelivered %}

                                            {% if order.status >= constant('AppBundle\\Entity\\Order\\Order::STATUS_INSERTED') %}
                                                {% include view('admin/orders/shipping_info.html.twig') %}
                                            {% else %}

                                                {% if attribute(shippingRules, 'type') is defined and 'self' == shippingRules.type %}

                                                    <a class="btn btn-default {{ order.deliveryAddress ? 'validated' }}"
                                                       data-url="{{ path('generator_company_shipping',{id: item.id}) }}"
                                                       data-toggle="modal"
                                                       data-delivery="{{ path('generator_delivery_address',{id: item.id}) }}"
                                                       data-target="#modal_details"
                                                       data-title="transportadora">
                                                        <i class="fa fa-truck"></i>
                                                        <br><small>Transportadora</small>
                                                    </a>

                                                {% else %}

                                                    <a class="btn btn-default {{ order.deliveryAddress ? 'validated' }}" data-toggle="modal" data-target="#modal_details"
                                                       data-url="{{ path('order_shipping_info', {id:order.id}) }}"
                                                       data-title="sices">
                                                        <i class="fa fa-truck"></i> <br><small>Frete Sices</small>
                                                    </a>

                                                {% endif %}

                                            {% endif %}

                                            {% if not order.isBuilding and not order.isPending and not order.isValidated and not order.isRejected %}
                                                <a class="btn btn-default {{ order.hasFile('payment') ? 'validated' }}" data-target="#modal_upload" data-toggle="modal"
                                                   data-href="{{ path('order_upload',{id:item.id}) }}">
                                                    <i class="fa fa-file-text"></i>
                                                    <br><small>Comprovante</small>
                                                </a>
                                            {% else %}
                                                <i class="btn btn-default fa fa fa-file-text">
                                                    <br>
                                                    <small>Comprov.</small>
                                                </i>
                                            {% endif %}

                                        </div>
                                    </td>
                                    <td>
                                        <a class="btn btn-default" href="{{ path('order_show', {id:item.id}) }}">
                                            <i class="fa fa-eye"></i> {{ 'View'|trans }}
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="row text-center">
        <div class="btn-group bt-xs">
            {{ knp_pagination_render(orders) }}
        </div>
    </div>
    <style>
        table tbody tr {
            display: table-row !important;
        }

        table thead tr td {
            font-weight: bold;
        }

        #company-save {
            display: none;
        }
    </style>
{% endblock %}

{% block scripts %}

    {% include view('helper.plugins_js') %}

    <script>
        var titleModal = $('#id_title');
        var edit_freight = $('#edit_freight');
        var form_Delivery = $('#formDelivery');

        $('[data-target="#modal_details"]').on('click', function () {
            var url = $(this).data('url');
            var delivery = $(this).data('delivery');

            var shipping = $(this).data('title');
            var title = (shipping == "sices") ? ' Frete Sices' : ' Dados da Transportadora';
            titleModal.html('<i class="fa fa-truck"> </i>'+ title);


            if (url) {
                $('#e_modal_details').modal('show');

                if (delivery) {
                    form_Delivery.removeClass('hide');
                    $.ajax({
                        url: delivery,
                        method: 'get',
                        success: function (response) {
                            form_Delivery.html(response);
                        }
                    });
                }

                $.ajax({
                    url: url,
                    method: 'get',
                    success: function (response) {
                        edit_freight.html(response);
                        if (shipping == "sices") {
                            form_Delivery.addClass('hide');
                            Delivery.deliveryModal();
                        }
                    }
                });
            } else {
                edit_freight.html('<h1> Erro ao Editar </h1>');
            }
        });

        $('#bt_save').click(function () {
            $('#company-save').trigger('click');
            $('#address-save').trigger('click')
            $('#e_modal_details').modal('hide');
        });

        var modalUpload = $('#modal_upload');
        var modalUploadBody = modalUpload.find('.modal-body');

        modalUpload.on('show.bs.modal', function (event) {
            var target = $(event.relatedTarget);
            var url = target.data('href');
            $.ajax({
                url: url,
                success: function (response) {
                    modalUploadBody.html(response);
                }
            });
        });

        var form_filtration = $("#form-filter");

        if(form_filtration.length){
          StatusFilter(form_filtration);
        }

        var statusAt = $('#filter_statusAt');

        statusAt.daterangepicker({
            locale: {
                format: 'DD/MM/YYYY',
                daysOfWeek: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
                monthNames: [
                    "Janeiro",
                    "Fevereiro",
                    "Março",
                    "Abril",
                    "Maio",
                    "Junho",
                    "Julho",
                    "Agosto",
                    "Setembro",
                    "Outubro",
                    "Novembro",
                    "Dezembro"
                ]
            }
        });

        statusAt.val('');

        $('#clear-statusAt').on('click', function () {
            statusAt.val('');
        });

        $('#filter_valueMin').on('change', function () {
            if ($('#filter_valueMax').val()) {
                var thisValue = Number($(this).val().replace(',','.'));
                var value = Number($('#filter_valueMax').val().replace(',','.'));

                if (thisValue > value) {
                    $(this).val((value.toString()).replace('.',','));
                    $('#filter_valueMax').val((thisValue.toString()).replace('.',','));
                }
            }
        });

        $('#filter_valueMax').on('change', function () {
            if ($('#filter_valueMin').val()) {
                var thisValue = Number($(this).val().replace(',','.'));
                var value = Number($('#filter_valueMin').val().replace(',','.'));

                if (thisValue < value) {
                    $(this).val((value.toString()).replace('.',','));
                    $('#filter_valueMin').val((thisValue.toString()).replace('.',','));
                }
            }
        });

        var sanitize = function(element){
            function clear(v){ return v.replace(/\D+/g,''); }
            var value = element.val();
            var backup = value.replace(/\./g,',');
            value = clear(value);
            if(backup.indexOf(',') > 0){
                var commas = backup.split(',');
                value = clear(commas[0])+',';
                if(commas[1].length){
                    value += clear(commas[1]);
                }
            }
            if(0 == backup.indexOf('-')){
                if(2 == backup.split('-').length){
                    value = '-' + value;
                }
            }
            element.val(value);
        };

        var custom_mask = function(element){
            element.on('keyup', function(){
                sanitize(element);
            });
        };

        var common_mask = {pattern: '##,##', reverse: true};
        var targets = {
            'filter_valueMin': common_mask,
            'filter_valueMax': common_mask
        };

        $.each(targets, function (id, options) {
            custom_mask($('#'+id));
        });

    </script>
{% endblock %}
