#!/usr/bin/env bash

LOGIN=$($CLI_PATH/util/github-credentials --login)

# contains labels formatted by: prefix:value
LABELS=$(curl -s -X GET -u $LOGIN $GITHUB_REPOSITORY/labels \
  | grep name \
  | grep -v Stage \
  | sed 's/"//g;s/,//g' \
  | awk '{print $2 $3}'
)

# contains Stage prefix name
STAGE_PREFIX=Stage

# contains prefixes names without repetition
GENERAL_PREFIXES=$(printf "${LABELS}" \
  | awk -F$':' '{print $1}' \
  | awk '!a[$0]++'
)

# contains selection titles
declare -A HEADERS=(
  [Category]='Select at least one category:\nUsage: enter 0 for multiple choose'
  [Priority]='Select the priority:'
  [Stage]='Select the stage:'
  [Type]='Select the type:'
)

# returns all labels filtered by prefix
get_prefixed_labels()
{
  printf "${LABELS}" | grep $1 | awk -F$':' '{print $2}'
}

# returns allowed stage labels, based on Category chosen
get_stage_labels()
{
  local backlog_type='general'

  for label in ${ISSUE_LABELS[@]}; do
    [[ $label == *'Devops'* ]] && backlog_type='devops'
  done

  echo "Backlog-${backlog_type}"
  echo 'To-do'
}

# contains all the selected labels
ISSUE_LABELS=()

# increments ISSUE_LABELS with the selected label prefixing it
set_issue_label()
{
  echo "> Selected label: ${2}"
  ISSUE_LABELS=(${ISSUE_LABELS[@]} "${1}:${2}")
}

# request the user to select multiple labels in the category options list
set_issue_multiple_labels()
{
  local prefix=$1
  local options=$2
  local label=''

  read -rep $'Usage: separate number using comma. sample: 1,4\n#? ' chosen

  for label_position in ${chosen//,/ }; do
    label=$(echo $options | awk "{print \$$label_position}")
    set_issue_label $prefix $label
  done
}

# requests the user to select a label in the options list
select_label()
{
  local prefix=$1
  local options=$2
  local error_message='Error: you must choose a valid option'

  echo "${HEADERS[$prefix]}"

  select label in $options; do
    if [[ -n $label ]]; then
      set_issue_label $prefix $label
      break
    elif [[ $prefix == 'Category' ]]; then
      set_issue_multiple_labels $prefix "${options}"
      break
    else
      echo "${error_message}"
    fi
  done
}

for prefix in ${GENERAL_PREFIXES[@]}; do
  select_label $prefix "$(get_prefixed_labels $prefix)"
done

select_label $STAGE_PREFIX "$(get_stage_labels)"

echo ${ISSUE_LABELS[@]}
