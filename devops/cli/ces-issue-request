#!/usr/bin/env bash

if [[ -z $1 ]] || [ $1 = '--help' ] || [ $1 = '-h' ]; then
  printf "ces-issue-request - help:
  Usage:
  ces-issue-request --[REQUEST_TYPE] \n
  Exemple:
  ces-issue-request --review \n"
  exit 0;
fi

BRANCH=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
ISSUE=${BRANCH/issue-/}

USER=$($CLI_PATH/util/github-credentials --user)
LOGIN=$($CLI_PATH/util/github-credentials --login)

if [[ $1 == '--review' ]]; then

  $CLI_PATH/ces-issue-move $ISSUE --review

  head="sices:$BRANCH"
  base="master"
  title="$BRANCH"
  body="connect to #$ISSUE"

  echo 'Creating Github pull request...'
  json="{\"head\": \"$head\", \"base\": \"$base\", \"title\": \"$title\", \"body\": \"$body\"}"
  response=$(curl -s -X POST -u $LOGIN -d "$json" $GITHUB_REPOSITORY/pulls)

  pr=$(echo $response | grep \"number\" | grep -oP '(?<="number": ).*(?=, "state")')
  url="https://github.com/sices/sices/pull/$pr/files"
  message="[$BRANCH] @here, _${USER}_ needs a *REVIEW*: $url"

  $CLI_PATH/ces-slack-notify --devops "$message"

elif [[ $1 == '--test' ]]; then
  echo 'tester proccess'
else
  echo "Error: invalid argument $1"
  exit 1
fi
