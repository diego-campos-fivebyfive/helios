#!/usr/bin/env bash

cd $SICES_PATH

if [[ -z $1 ]] || [ $1 = '--help' ] || [ $1 = '-h' ]; then
  printf "ces-issue-close - help:
  Usage:
  ces-issue-close [ISSUE_NUMBER] \n
  Exemple:
  ces-issue-close 100 \n
  Force close exemple:
  ces-issue-close 100 -f \n"
  exit 0;
fi

ISSUE=$1
STAGE=$($CLI_PATH/ces-issue-info $ISSUE --stage)

if [[ $STAGE == 'Closed' ]]; then
  echo "issue-$1 already closed."
  $CLI_PATH/ces-branch-clear $ISSUE $2
  exit 0
fi

if [ "$2" != '-f' ] && [[ $STAGE != 'Testing' ]]; then
  read -p "Warning: this issue-$1 is not on testing column, if you are sure about deleting this, you must use -f arg. Press ENTER to continue."
  exit 0
fi

LOGIN=$($CLI_PATH/util/github-credentials --login)

curl -s -X PATCH -u $LOGIN -d '{"state": "closed"}' $GITHUB_REPOSITORY/issues/$ISSUE >/dev/null 2>&1
$CLI_PATH/ces-branch-clear $ISSUE $2
