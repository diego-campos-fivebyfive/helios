#!/usr/bin/env bash

cd $SICES_PATH

if [[ $1 == '--help' || $1 == '-h' ]]; then
  printf "ces-app-deploy - help: \n
  Usage:
  ces-app-deploy \n"
  exit 0;
fi

echo "Starting Deploy..."

if [[ $CES_AMBIENCE == 'homolog' ]]; then

  $CLI_PATH/ces-slack-notify --homolog "Starting Homolog Deploy..."
  $CLI_PATH/ces-app-clone --homolog
  $CLI_PATH/ces-permission-fix --homolog
  source $CLI_PATH/config/variables-ci --homolog
  $CLI_PATH/ces-app-install
  $CLI_PATH/ces-database-update
  $CLI_PATH/ces-cache-clear
  $CLI_PATH/ces-frontend-compile

  [ -d $PROJECT_ROOT/web/app ] && {
    $CLI_PATH/ces-slack-notify --homolog "Frontend Build Failed!"
  }

  $CLI_PATH/ces-slack-notify --homolog "Homolog Deploy Done!"

elif [[ $CES_AMBIENCE == 'production' ]]; then

  $CLI_PATH/ces-slack-notify --production '@here: Starting Production Deploy...'
  $CLI_PATH/ces-permission-fix --production
  $CLI_PATH/ces-app-clone --production
  source $CLI_PATH/config/variables-ci --production
  $CLI_PATH/ces-app-config --production
  $CLI_PATH/ces-cache-clear
  $CLI_PATH/ces-database-update

  # Cleaning uploaded files
  rm .uploads/component/image/**
  rm .uploads/component/datasheet/**
  rm .uploads/proposal/proposal/**
  rm .uploads/order/payment/**
  rm .uploads/order/proforma/**
  rm .uploads/order/order/**

  $CLI_PATH/ces-slack-notify --production '@here: Production Deploy Done!'

else
  echo '$CES_AMBIENCE variable is not defined'
fi

echo 'Done.'
