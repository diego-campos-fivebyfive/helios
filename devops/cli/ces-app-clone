#!/usr/bin/env bash

cd $SICES_PATH

get_help()
{
  printf "ces-app-clone - help:
  Usage:
  ces-app-clone --AMBIENCE \n
  Exemple:
  ces-app-clone --production \n
  Avaliable Args:
  [ --homolog | --production ] \n"
}

if [[ -z $1 ]] || [ $1 = '--help' ] || [ $1 = '-h' ]; then
  get_help
  exit 0
fi

echo "Cloning $1 files..."

if [ $1 = '--homolog' ]; then

  git fetch origin
  GIT_WORK_TREE=$SICES_PATH git checkout -f
  git pull origin master -f

elif [ $1 = '--production' ]; then

  echo "Importing Temp files from homolog Server..."
  rsync -azvv --delete \
    -e "ssh -i $SICES_PATH/devops/aws/homolog.pem" \
    admin@$SICES_HOMOLOG_IP:$SICES_PATH/** $SICES_PATH/.temp

  echo "Creating current version Backup..."
  rsync -avzh --delete $SICES_PATH/** $SICES_PATH/.backup

  echo "Deploying files from Temp..."
  rsync -avzh --delete $SICES_PATH/.temp/** $SICES_PATH

  echo "Replacing Frontend homolog URI..."
  sed -i "s,${SICES_HOMOLOG_URI},${SICES_PRODUCTION_URI},g;" \
    backend/web/app/main.js

else
  echo -e "\033[0;31mError: Invalid Ambience Argument:\033[0m $1"
  get_help
  exit 1
fi
