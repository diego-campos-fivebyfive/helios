#!/usr/bin/env bash

cd $SICES_PATH

if [[ -z $1 ]] || [ $1 = '--help' ] || [ $1 = '-h' ]; then
  printf "ces-app-clone - help:

  Usage:

  ces-app-clone --AMBIENCE

  Exemple:

  ces-app-clone --production

  "
  exit 0;
fi

echo "Cloning $1 files..."

if [ $1 = '--homolog' ]; then

  git fetch origin
  GIT_WORK_TREE=$SICES_PATH git checkout -f
  git pull origin master -f

elif [ $1 = '--production' ]; then

  path=$SICES_PATH

  echo "Importing Temp files from homolog..."
  rsync -azvv --delete -e "ssh -i $path/devops/aws/homolog.pem" admin@54.233.150.10:$path/** $path/.temp

  echo "Creating current version Backup..."
  rsync -avzh --delete $path/** $path/.backup

  echo "Moving untracked files..."
  rsync -avzh $path/.backup/backend/web/uploads/** $path/.temp/backend/web/uploads
  rsync -avzh $path/.backup/backend/storage/** $path/.temp/backend/storage

  # Remove it after deploy command optimizations
  rm $path/.temp/devops/aws/homolog.pem
  cp $path/.backup/devops/aws/homolog.pem $path/.temp/devops/aws/homolog.pem
  rm $path/.temp/backend/app/config/parameters.yml
  cp $path/.backup/backend/app/config/parameters.yml $path/.temp/backend/app/config/parameters.yml
  rm $path/.temp/backend/src/AppBundle/Service/Notifier/Notifier.php
  cp $path/.backup/backend/src/AppBundle/Service/Notifier/Notifier.php $path/.temp/backend/src/AppBundle/Service/Notifier/Notifier.php
  # Finish Remove it

  echo "Deploying files from Temp..."
  rsync -avzh --delete $path/.temp/** $path

fi
